<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpaca Trading Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #1e88e5;
            --secondary-color: #26a69a;
            --success-color: #66bb6a;
            --danger-color: #ef5350;
            --warning-color: #ffca28;
            --info-color: #29b6f6;
            --dark-bg: #212529;
            --light-bg: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            font-weight: bold;
            border-radius: 10px 10px 0 0 !important;
        }
        
        .positive {
            color: var(--success-color);
        }
        
        .negative {
            color: var(--danger-color);
        }
        
        .neutral {
            color: var(--info-color);
        }
        
        .buy-signal {
            background-color: rgba(102, 187, 106, 0.2);
            border-left: 4px solid var(--success-color);
        }
        
        .sell-signal {
            background-color: rgba(239, 83, 80, 0.2);
            border-left: 4px solid var(--danger-color);
        }
        
        .neutral-signal {
            background-color: rgba(41, 182, 246, 0.2);
            border-left: 4px solid var(--info-color);
        }
        
        .symbol-card {
            cursor: pointer;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 0.2em solid rgba(0, 0, 0, 0.1);
            border-top: 0.2em solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tab-content {
            padding: 20px 0;
        }
        
        #symbolsContainer .card {
            height: 100%;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        
        .btn-action {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .indicator-value {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .position-badge {
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 20px;
        }
        
        .badge-long {
            background-color: var(--success-color);
            color: white;
        }
        
        .badge-short {
            background-color: var(--danger-color);
            color: white;
        }
        
        .badge-neutral {
            background-color: var(--info-color);
            color: white;
        }
        
        .modal-content {
            border-radius: 15px;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>Alpaca Trading Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" id="dashboardLink">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="portfolioLink">Portfolio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="backtestLink">Backtest</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="ordersLink">Orders</a>
                    </li>
                </ul>
                <span class="navbar-text" id="accountBalance">
                    <i class="fas fa-wallet me-1"></i> Loading balance...
                </span>
            </div>
        </div>
    </nav>

    <!-- Main Content Container -->
    <div class="container-fluid mt-4">
        <div id="mainContent">
            <!-- Content will be loaded here dynamically -->
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading dashboard...</p>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container">
        <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-bell me-2"></i>
                <strong class="me-auto" id="toastTitle">Notification</strong>
                <small id="toastTime">Just now</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                This is a notification message.
            </div>
        </div>
    </div>

    <!-- Modal Templates -->
    <div class="modal fade" id="actionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionModalTitle">Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="actionModalBody">
                    <!-- Content will be loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="actionModalConfirm">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap and jQuery JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Global variables
        let symbols = {{ symbols|tojson }};
        let currentSymbol = null;
        let chartInstances = {};
        let refreshInterval = null;
        let currentView = 'dashboard';
        
        // Initialize Bootstrap components
        const toastElement = document.getElementById('notificationToast');
        const toast = new bootstrap.Toast(toastElement);
        const actionModal = new bootstrap.Modal(document.getElementById('actionModal'));
        
        // Show notification
        function showNotification(title, message, type = 'info') {
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastMessage').textContent = message;
            document.getElementById('toastTime').textContent = new Date().toLocaleTimeString();
            
            // Remove previous classes
            toastElement.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info', 'text-white');
            
            // Add appropriate class based on type
            if (type === 'success') {
                toastElement.classList.add('bg-success', 'text-white');
            } else if (type === 'error') {
                toastElement.classList.add('bg-danger', 'text-white');
            } else if (type === 'warning') {
                toastElement.classList.add('bg-warning');
            } else {
                toastElement.classList.add('bg-info', 'text-white');
            }
            
            toast.show();
        }
        
        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
        }
        
        // Format percentage
        function formatPercentage(value) {
            return new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value / 100);
        }
        
        // Add positive/negative class based on value
        function getValueColorClass(value) {
            return value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
        }
        
        // Document ready function
        $(document).ready(function() {
            // Initial load
            loadDashboard();
            updateAccountBalance();
            
            // Set up refresh interval (every 60 seconds)
            refreshInterval = setInterval(function() {
                if (currentView === 'dashboard') {
                    loadDashboard();
                }
                updateAccountBalance();
            }, 60000);
            
            // Navigation event handlers
            $('#dashboardLink').click(function(e) {
                e.preventDefault();
                currentView = 'dashboard';
                loadDashboard();
                updateNavActive(this);
            });
            
            $('#portfolioLink').click(function(e) {
                e.preventDefault();
                currentView = 'portfolio';
                loadPortfolio();
                updateNavActive(this);
            });
            
            $('#backtestLink').click(function(e) {
                e.preventDefault();
                currentView = 'backtest';
                loadBacktest();
                updateNavActive(this);
            });
            
            $('#ordersLink').click(function(e) {
                e.preventDefault();
                currentView = 'orders';
                loadOrders();
                updateNavActive(this);
            });
        });
        
        // Update active navigation link
        function updateNavActive(element) {
            $('.nav-link').removeClass('active');
            $(element).addClass('active');
        }
        
        // Update account balance in navbar
        function updateAccountBalance() {
            $.ajax({
                url: '/api/balance',
                method: 'GET',
                success: function(data) {
                    const balanceHtml = `
                        <i class="fas fa-wallet me-1"></i> 
                        ${formatCurrency(data.portfolio_value)} 
                        <span class="${getValueColorClass(data.today_pl)}">
                            (${data.today_pl > 0 ? '+' : ''}${formatCurrency(data.today_pl)} / 
                            ${data.today_pl_pct > 0 ? '+' : ''}${data.today_pl_pct.toFixed(2)}%)
                        </span>
                    `;
                    $('#accountBalance').html(balanceHtml);
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching account balance:', error);
                    $('#accountBalance').html('<i class="fas fa-exclamation-triangle text-warning"></i> Error loading balance');
                }
            });
        }
        
        // Load dashboard view
        function loadDashboard() {
            $('#mainContent').html('<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">Loading dashboard...</p></div>');
            
            // Fetch trading status and account info
            $.ajax({
                url: '/api/status',
                method: 'GET',
                success: function(statusData) {
                    // Fetch positions
                    $.ajax({
                        url: '/api/positions',
                        method: 'GET',
                        success: function(positionsData) {
                            // Fetch signals
                            $.ajax({
                                url: '/api/signals',
                                method: 'GET',
                                success: function(signalsData) {
                                    renderDashboard(statusData, positionsData, signalsData);
                                },
                                error: function(xhr, status, error) {
                                    console.error('Error fetching signals:', error);
                                    showNotification('Error', 'Failed to load trading signals', 'error');
                                    renderDashboard(statusData, positionsData, {});
                                }
                            });
                        },
                        error: function(xhr, status, error) {
                            console.error('Error fetching positions:', error);
                            showNotification('Error', 'Failed to load positions', 'error');
                            renderDashboard(statusData, [], {});
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching trading status:', error);
                    showNotification('Error', 'Failed to load trading status', 'error');
                    $('#mainContent').html('<div class="alert alert-danger">Failed to load trading data. Please try again later.</div>');
                }
            });
        }
        
        // Render dashboard with all data
        function renderDashboard(statusData, positionsData, signalsData) {
            // Prepare dashboard HTML
            let dashboardHtml = `
                <div class="row">
                    <!-- Account Summary Section -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-dark text-white">
                                <i class="fas fa-user-circle me-2"></i>Account Summary
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-7">Portfolio Value:</div>
                                    <div class="col-5 text-end fw-bold">${formatCurrency(statusData.account.portfolio_value)}</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-7">Cash:</div>
                                    <div class="col-5 text-end fw-bold">${formatCurrency(statusData.account.cash)}</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-7">Today's P/L:</div>
                                    <div class="col-5 text-end fw-bold ${getValueColorClass(statusData.account.today_pl)}">
                                        ${statusData.account.today_pl > 0 ? '+' : ''}${formatCurrency(statusData.account.today_pl)}
                                        (${statusData.account.today_pl_pct > 0 ? '+' : ''}${statusData.account.today_pl_pct.toFixed(2)}%)
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-7">Buying Power:</div>
                                    <div class="col-5 text-end fw-bold">${formatCurrency(statusData.account.buying_power)}</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-7">Market Status:</div>
                                    <div class="col-5 text-end">
                                        <span class="badge ${statusData.market_open ? 'bg-success' : 'bg-danger'}">
                                            ${statusData.market_open ? 'OPEN' : 'CLOSED'}
                                        </span>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-7">Trading Enabled:</div>
                                    <div class="col-5 text-end">
                                        <div class="form-check form-switch d-flex justify-content-end">
                                            <input class="form-check-input" type="checkbox" id="tradingEnabledSwitch" 
                                                ${statusData.trading_enabled ? 'checked' : ''}>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" id="refreshDataBtn">
                                        <i class="fas fa-sync-alt me-2"></i>Refresh Data
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Trading Actions Card -->
                        <div class="card mt-4">
                            <div class="card-header bg-dark text-white">
                                <i class="fas fa-sliders-h me-2"></i>Trading Actions
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary btn-action" id="runAnalysisBtn">
                                        <i class="fas fa-chart-line me-2"></i>Run Analysis
                                    </button>
                                    <button class="btn btn-outline-success btn-action" id="closeAllPositionsBtn">
                                        <i class="fas fa-power-off me-2"></i>Close All Positions
                                    </button>
                                    <button class="btn btn-outline-warning btn-action" id="cancelAllOrdersBtn">
                                        <i class="fas fa-ban me-2"></i>Cancel All Orders
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Positions Section -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header bg-dark text-white">
                                <i class="fas fa-exchange-alt me-2"></i>Current Positions
                            </div>
                            <div class="card-body">
                                ${renderPositionsTable(positionsData)}
                            </div>
                        </div>
                        
                        <!-- Recent Signals Card -->
                        <div class="card mt-4">
                            <div class="card-header bg-dark text-white">
                                <i class="fas fa-bell me-2"></i>Recent Signals
                            </div>
                            <div class="card-body">
                                ${renderSignalsTable(signalsData)}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Symbol Details Section (will be shown when a symbol is selected) -->
                <div class="row mt-4" id="symbolDetailsSection" style="display: none;">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-dark text-white">
                                <i class="fas fa-chart-bar me-2"></i><span id="symbolDetailsTitle">Symbol Details</span>
                            </div>
                            <div class="card-body">
                                <div id="symbolDetailsContent">
                                    <!-- Symbol details will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Update main content
            $('#mainContent').html(dashboardHtml);
            
            // Set up event handlers
            setupDashboardEventHandlers(statusData);
        }
        
        // Render positions table
        function renderPositionsTable(positions) {
            if (positions.length === 0) {
                return '<div class="alert alert-info">No open positions at the moment.</div>';
            }
            
            let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Qty</th>
                                <th>Entry</th>
                                <th>Current</th>
                                <th>P/L</th>
                                <th>P/L %</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            positions.forEach(position => {
                const unrealizedPL = parseFloat(position.unrealized_pl);
                const unrealizedPLPercent = parseFloat(position.unrealized_plpc) * 100;
                const isLong = parseFloat(position.qty) > 0;
                
                tableHtml += `
                    <tr>
                        <td>
                            <span class="position-badge ${isLong ? 'badge-long' : 'badge-short'}">
                                ${isLong ? 'LONG' : 'SHORT'}
                            </span>
                            <strong class="ms-2">${position.symbol}</strong>
                        </td>
                        <td>${Math.abs(parseFloat(position.qty))}</td>
                        <td>${formatCurrency(parseFloat(position.avg_entry_price))}</td>
                        <td>${formatCurrency(parseFloat(position.current_price))}</td>
                        <td class="${getValueColorClass(unrealizedPL)}">
                            ${unrealizedPL > 0 ? '+' : ''}${formatCurrency(unrealizedPL)}
                        </td>
                        <td class="${getValueColorClass(unrealizedPLPercent)}">
                            ${unrealizedPLPercent > 0 ? '+' : ''}${unrealizedPLPercent.toFixed(2)}%
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary view-symbol-btn" data-symbol="${position.symbol}">
                                <i class="fas fa-chart-line"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger close-position-btn" data-symbol="${position.symbol}">
                                <i class="fas fa-times"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return tableHtml;
        }
        
        // Render signals table
        function renderSignalsTable(signals) {
            if (!signals || Object.keys(signals).length === 0) {
                return '<div class="alert alert-info">No recent signals available.</div>';
            }
            
            let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Signal</th>
                                <th>Price</th>
                                <th>Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            Object.keys(signals).forEach(symbol => {
                const signal = signals[symbol];
                let signalClass = '';
                let signalText = '';
                
                if (signal.signal === 'buy') {
                    signalClass = 'buy-signal';
                    signalText = 'BUY';
                } else if (signal.signal === 'sell') {
                    signalClass = 'sell-signal';
                    signalText = 'SELL';
                } else {
                    signalClass = 'neutral-signal';
                    signalText = 'HOLD';
                }
                
                tableHtml += `
                    <tr class="${signalClass}">
                        <td><strong>${symbol}</strong></td>
                        <td>
                            <span class="badge ${signal.signal === 'buy' ? 'bg-success' : signal.signal === 'sell' ? 'bg-danger' : 'bg-info'}">
                                ${signalText}
                            </span>
                        </td>
                        <td>${formatCurrency(signal.price)}</td>
                        <td>${new Date(signal.timestamp).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary view-symbol-btn" data-symbol="${symbol}">
                                <i class="fas fa-chart-line"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success place-order-btn" data-symbol="${symbol}" data-signal="${signal.signal}">
                                <i class="fas fa-play"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return tableHtml;
        }
        
        // Set up event handlers for dashboard
        function setupDashboardEventHandlers(statusData) {
            // Refresh data button
            $('#refreshDataBtn').click(function() {
                loadDashboard();
                updateAccountBalance();
                showNotification('Refresh', 'Dashboard data refreshed', 'info');
            });
            
            // Trading enabled switch
            $('#tradingEnabledSwitch').change(function() {
                const enabled = $(this).is(':checked');
                $.ajax({
                    url: '/api/trading/enable',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ enabled: enabled }),
                    success: function(response) {
                        showNotification('Trading Status', `Trading ${enabled ? 'enabled' : 'disabled'} successfully`, 'success');
                    },
                    error: function(xhr, status, error) {
                        console.error('Error changing trading status:', error);
                        showNotification('Error', 'Failed to change trading status', 'error');
                        // Revert the switch
                        $('#tradingEnabledSwitch').prop('checked', !enabled);
                    }
                });
            });
            
            // Run analysis button
            $('#runAnalysisBtn').click(function() {
                $(this).prop('disabled', true);
                $(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Running...');
                
                $.ajax({
                    url: '/api/analyze',
                    method: 'POST',
                    success: function(response) {
                        showNotification('Analysis', 'Analysis completed successfully', 'success');
                        loadDashboard(); // Refresh dashboard to show new signals
                    },
                    error: function(xhr, status, error) {
                        console.error('Error running analysis:', error);
                        showNotification('Error', 'Failed to run analysis', 'error');
                    },
                    complete: function() {
                        $('#runAnalysisBtn').prop('disabled', false);
                        $('#runAnalysisBtn').html('<i class="fas fa-chart-line me-2"></i>Run Analysis');
                    }
                });
            });
            
            // Close all positions button
            $('#closeAllPositionsBtn').click(function() {
                if (confirm('Are you sure you want to close all positions?')) {
                    $(this).prop('disabled', true);
                    $(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Closing...');
                    
                    $.ajax({
                        url: '/api/positions/close_all',
                        method: 'POST',
                        success: function(response) {
                            showNotification('Positions', 'All positions closed successfully', 'success');
                            loadDashboard(); // Refresh dashboard
                        },
                        error: function(xhr, status, error) {
                            console.error('Error closing positions:', error);
                            showNotification('Error', 'Failed to close all positions', 'error');
                        },
                        complete: function() {
                            $('#closeAllPositionsBtn').prop('disabled', false);
                            $('#closeAllPositionsBtn').html('<i class="fas fa-power-off me-2"></i>Close All Positions');
                        }
                    });
                }
            });
            
            // Cancel all orders button
            $('#cancelAllOrdersBtn').click(function() {
                if (confirm('Are you sure you want to cancel all pending orders?')) {
                    $(this).prop('disabled', true);
                    $(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Cancelling...');
                    
                    $.ajax({
                        url: '/api/orders/cancel_all',
                        method: 'POST',
                        success: function(response) {
                            showNotification('Orders', 'All orders cancelled successfully', 'success');
                            loadDashboard(); // Refresh dashboard
                        },
                        error: function(xhr, status, error) {
                            console.error('Error cancelling orders:', error);
                            showNotification('Error', 'Failed to cancel all orders', 'error');
                        },
                        complete: function() {
                            $('#cancelAllOrdersBtn').prop('disabled', false);
                            $('#cancelAllOrdersBtn').html('<i class="fas fa-ban me-2"></i>Cancel All Orders');
                        }
                    });
                }
            });
            
            // View symbol details
            $('.view-symbol-btn').click(function() {
                const symbol = $(this).data('symbol');
                loadSymbolDetails(symbol);
            });
            
            // Close position button
            $('.close-position-btn').click(function() {
                const symbol = $(this).data('symbol');
                if (confirm(`Are you sure you want to close your position in ${symbol}?`)) {
                    $.ajax({
                        url: '/api/positions/close',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ symbol: symbol }),
                        success: function(response) {
                            showNotification('Position Closed', `${symbol} position closed successfully`, 'success');
                            loadDashboard(); // Refresh dashboard
                        },
                        error: function(xhr, status, error) {
                            console.error('Error closing position:', error);
                            showNotification('Error', `Failed to close ${symbol} position`, 'error');
                        }
                    });
                }
            });
            
            // Place order button
            $('.place-order-btn').click(function() {
                const symbol = $(this).data('symbol');
                const signal = $(this).data('signal');
                
                // Show order modal
                $('#actionModalTitle').text(`Place ${signal.toUpperCase()} Order for ${symbol}`);
                
                const modalContent = `
                    <form id="orderForm">
                        <div class="mb-3">
                            <label for="orderType" class="form-label">Order Type</label>
                            <select class="form-select" id="orderType">
                                <option value="market">Market</option>
                                <option value="limit">Limit</option>
                                <option value="stop">Stop</option>
                                <option value="stop_limit">Stop Limit</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="orderQty" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="orderQty" min="1" value="1">
                        </div>
                        <div class="mb-3 limit-price-group" style="display: none;">
                            <label for="limitPrice" class="form-label">Limit Price</label>
                            <input type="number" class="form-control" id="limitPrice" step="0.01">
                        </div>
                        <div class="mb-3 stop-price-group" style="display: none;">
                            <label for="stopPrice" class="form-label">Stop Price</label>
                            <input type="number" class="form-control" id="stopPrice" step="0.01">
                        </div>
                    </form>
                `;
                
                $('#actionModalBody').html(modalContent);
                $('#actionModalConfirm').text('Place Order');
                
                // Show/hide price fields based on order type
                $('#orderType').change(function() {
                    const orderType = $(this).val();
                    $('.limit-price-group').toggle(orderType === 'limit' || orderType === 'stop_limit');
                    $('.stop-price-group').toggle(orderType === 'stop' || orderType === 'stop_limit');
                });
                
                // Set up confirm button
                $('#actionModalConfirm').off('click').on('click', function() {
                    const orderType = $('#orderType').val();
                    const qty = $('#orderQty').val();
                    const limitPrice = $('#limitPrice').val() || null;
                    const stopPrice = $('#stopPrice').val() || null;
                    
                    const orderData = {
                        symbol: symbol,
                        side: signal,
                        type: orderType,
                        qty: qty
                    };
                    
                    if (limitPrice) orderData.limit_price = limitPrice;
                    if (stopPrice) orderData.stop_price = stopPrice;
                    
                    $.ajax({
                        url: '/api/orders/place',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(orderData),
                        success: function(response) {
                            actionModal.hide();
                            showNotification('Order Placed', `${signal.toUpperCase()} order for ${symbol} placed successfully`, 'success');
                            loadDashboard(); // Refresh dashboard
                        },
                        error: function(xhr, status, error) {
                            console.error('Error placing order:', error);
                            showNotification('Error', `Failed to place order for ${symbol}`, 'error');
                        }
                    });
                });
                
                actionModal.show();
            });
        }
        
        // Load symbol details
        function loadSymbolDetails(symbol) {
            $('#symbolDetailsSection').show();
            $('#symbolDetailsTitle').text(`${symbol} Details`);
            $('#symbolDetailsContent').html('<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">Loading symbol data...</p></div>');
            
            // Fetch symbol data
            $.ajax({
                url: `/api/symbol/${symbol}`,
                method: 'GET',
                success: function(data) {
                    renderSymbolDetails(symbol, data);
                },
                error: function(xhr, status, error) {
                    console.error(`Error fetching ${symbol} details:`, error);
                    $('#symbolDetailsContent').html(`<div class="alert alert-danger">Failed to load details for ${symbol}. Please try again later.</div>`);
                }
            });
        }
        
        // Render symbol details
        function renderSymbolDetails(symbol, data) {
            // Create tabs for different views
            const detailsHtml = `
                <ul class="nav nav-tabs" id="symbolTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                            Overview
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart" type="button" role="tab">
                            Chart
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="indicators-tab" data-bs-toggle="tab" data-bs-target="#indicators" type="button" role="tab">
                            Indicators
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">
                            Orders
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="symbolTabContent">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mt-3">
                                    <div class="card-header">
                                        <i class="fas fa-info-circle me-2"></i>Symbol Information
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-2">
                                            <div class="col-6">Symbol:</div>
                                            <div class="col-6 text-end fw-bold">${symbol}</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-6">Current Price:</div>
                                            <div class="col-6 text-end fw-bold">${formatCurrency(data.price)}</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-6">Day Change:</div>
                                            <div class="col-6 text-end fw-bold ${getValueColorClass(data.day_change_percent)}">
                                                ${data.day_change_percent > 0 ? '+' : ''}${data.day_change_percent.toFixed(2)}%
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-6">Volume:</div>
                                            <div class="col-6 text-end">${data.volume.toLocaleString()}</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-6">Signal:</div>
                                            <div class="col-6 text-end">
                                                <span class="badge ${data.signal === 'buy' ? 'bg-success' : data.signal === 'sell' ? 'bg-danger' : 'bg-info'}">
                                                    ${data.signal === 'buy' ? 'BUY' : data.signal === 'sell' ? 'SELL' : 'HOLD'}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card mt-3">
                                    <div class="card-header">
                                        <i class="fas fa-cogs me-2"></i>Strategy Parameters
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-2">
                                            <div class="col-6">Strategy:</div>
                                            <div class="col-6 text-end">${data.strategy.name || 'Default'}</div>
                                        </div>
                                        ${Object.entries(data.strategy.params || {}).map(([key, value]) => `
                                            <div class="row mb-2">
                                                <div class="col-6">${key}:</div>
                                                <div class="col-6 text-end">${value}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card mt-3">
                                    <div class="card-header">
                                        <i class="fas fa-chart-line me-2"></i>Performance
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="performanceChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card mt-3">
                                    <div class="card-header">
                                        <i class="fas fa-exchange-alt me-2"></i>Position
                                    </div>
                                    <div class="card-body">
                                        ${data.position ? `
                                            <div class="row mb-2">
                                                <div class="col-6">Side:</div>
                                                <div class="col-6 text-end">
                                                    <span class="badge ${parseFloat(data.position.qty) > 0 ? 'bg-success' : 'bg-danger'}">
                                                        ${parseFloat(data.position.qty) > 0 ? 'LONG' : 'SHORT'}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-6">Quantity:</div>
                                                <div class="col-6 text-end">${Math.abs(parseFloat(data.position.qty))}</div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-6">Entry Price:</div>
                                                <div class="col-6 text-end">${formatCurrency(parseFloat(data.position.avg_entry_price))}</div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-6">Current P/L:</div>
                                                <div class="col-6 text-end ${getValueColorClass(parseFloat(data.position.unrealized_pl))}">
                                                    ${parseFloat(data.position.unrealized_pl) > 0 ? '+' : ''}${formatCurrency(parseFloat(data.position.unrealized_pl))}
                                                </div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-6">P/L %:</div>
                                                <div class="col-6 text-end ${getValueColorClass(parseFloat(data.position.unrealized_plpc) * 100)}">
                                                    ${parseFloat(data.position.unrealized_plpc) * 100 > 0 ? '+' : ''}${(parseFloat(data.position.unrealized_plpc) * 100).toFixed(2)}%
                                                </div>
                                            </div>
                                            <div class="d-grid gap-2 mt-3">
                                                <button class="btn btn-danger close-position-btn" data-symbol="${symbol}">
                                                    <i class="fas fa-times me-2"></i>Close Position
                                                </button>
                                            </div>
                                        ` : `
                                            <div class="alert alert-info">No open position for ${symbol}</div>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-success open-position-btn" data-symbol="${symbol}" data-side="buy">
                                                    <i class="fas fa-arrow-up me-2"></i>Buy
                                                </button>
                                                <button class="btn btn-danger open-position-btn" data-symbol="${symbol}" data-side="sell">
                                                    <i class="fas fa-arrow-down me-2"></i>Sell Short
                                                </button>
                                            </div>
                                        `}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chart Tab -->
                    <div class="tab-pane fade" id="chart" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-header">
                                <div class="row">
                                    <div class="col-md-6">
                                        <i class="fas fa-chart-bar me-2"></i>Price Chart
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-primary timeframe-btn" data-timeframe="1D">1D</button>
                                            <button type="button" class="btn btn-sm btn-outline-primary timeframe-btn" data-timeframe="1W">1W</button>
                                            <button type="button" class="btn btn-sm btn-outline-primary timeframe-btn active" data-timeframe="1M">1M</button>
                                            <button type="button" class="btn btn-sm btn-outline-primary timeframe-btn" data-timeframe="3M">3M</button>
                                            <button type="button" class="btn btn-sm btn-outline-primary timeframe-btn" data-timeframe="1Y">1Y</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 500px;">
                                    <canvas id="priceChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Indicators Tab -->
                    <div class="tab-pane fade" id="indicators" role="tabpanel">
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-chart-line me-2"></i>Technical Indicators
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-6">RSI (14):</div>
                                            <div class="col-6 text-end">
                                                <span class="indicator-value ${data.indicators.rsi < 30 ? 'text-success' : data.indicators.rsi > 70 ? 'text-danger' : ''}">
                                                    ${data.indicators.rsi.toFixed(2)}
                                                </span>
                                                <small class="text-muted ms-2">
                                                    ${data.indicators.rsi < 30 ? 'Oversold' : data.indicators.rsi > 70 ? 'Overbought' : 'Neutral'}
                                                </small>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-6">MACD:</div>
                                            <div class="col-6 text-end">
                                                <span class="indicator-value ${getValueColorClass(data.indicators.macd)}">
                                                    ${data.indicators.macd.toFixed(2)}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-6">Signal Line:</div>
                                            <div class="col-6 text-end">
                                                <span class="indicator-value">
                                                    ${data.indicators.macd_signal.toFixed(2)}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-6">MACD Histogram:</div>
                                            <div class="col-6 text-end">
                                                <span class="indicator-value ${getValueColorClass(data.indicators.macd_hist)}">
                                                    ${data.indicators.macd_hist.toFixed(2)}
                                                </span>
                                                <small class="text-muted ms-2">
                                                    ${data.indicators.macd_hist > 0 ? 'Bullish' : 'Bearish'}
                                                </small>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-6">SMA (20):</div>
                                            <div class="col-6 text-end">
                                                <span class="indicator-value">
                                                    ${formatCurrency(data.indicators.sma_20)}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-6">SMA (50):</div>
                                            <div class="col-6 text-end">
                                                <span class="indicator-value">
                                                    ${formatCurrency(data.indicators.sma_50)}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-6">SMA (200):</div>
                                            <div class="col-6 text-end">
                                                <span class="indicator-value">
                                                    ${formatCurrency(data.indicators.sma_200)}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-signal me-2"></i>Indicator Charts
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container mb-4">
                                            <canvas id="rsiChart"></canvas>
                                        </div>
                                        <div class="chart-container">
                                            <canvas id="macdChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Orders Tab -->
                    <div class="tab-pane fade" id="orders" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-header">
                                <div class="row">
                                    <div class="col-md-6">
                                        <i class="fas fa-clipboard-list me-2"></i>Recent Orders
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <button class="btn btn-sm btn-primary" id="placeOrderBtn" data-symbol="${symbol}">
                                            <i class="fas fa-plus me-2"></i>Place New Order
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                ${renderOrdersTable(data.orders || [])}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Update content
            $('#symbolDetailsContent').html(detailsHtml);
            
            // Initialize charts
            initPerformanceChart(data.performance || []);
            initPriceChart(data.prices || []);
            initIndicatorCharts(data.indicators || {});
            
            // Set up event handlers
            setupSymbolDetailsEventHandlers(symbol, data);
        }
        
        // Render orders table
        function renderOrdersTable(orders) {
            if (orders.length === 0) {
                return '<div class="alert alert-info">No recent orders for this symbol.</div>';
            }
            
            let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Type</th>
                                <th>Side</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            orders.forEach(order => {
                tableHtml += `
                    <tr>
                        <td>${order.id.substring(0, 8)}...</td>
                        <td>${order.type.toUpperCase()}</td>
                        <td>
                            <span class="badge ${order.side === 'buy' ? 'bg-success' : 'bg-danger'}">
                                ${order.side.toUpperCase()}
                            </span>
                        </td>
                        <td>${order.qty}</td>
                        <td>${order.filled_avg_price ? formatCurrency(parseFloat(order.filled_avg_price)) : '-'}</td>
                        <td>
                            <span class="badge ${order.status === 'filled' ? 'bg-success' : order.status === 'canceled' ? 'bg-secondary' : 'bg-primary'}">
                                ${order.status.toUpperCase()}
                            </span>
                        </td>
                        <td>${new Date(order.created_at).toLocaleString()}</td>
                        <td>
                            ${order.status === 'new' || order.status === 'partially_filled' ? `
                                <button class="btn btn-sm btn-outline-danger cancel-order-btn" data-order-id="${order.id}">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return tableHtml;
        }
        
        // Initialize performance chart
        function initPerformanceChart(performanceData) {
            if (!performanceData || performanceData.length === 0) {
                return;
            }
            
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            // Prepare data
            const labels = performanceData.map(item => new Date(item.date).toLocaleDateString());
            const returns = performanceData.map(item => item.return_pct);
            
            // Create chart
            if (chartInstances.performance) {
                chartInstances.performance.destroy();
            }
            
            chartInstances.performance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Strategy Returns (%)',
                        data: returns,
                        backgroundColor: 'rgba(30, 136, 229, 0.2)',
                        borderColor: 'rgba(30, 136, 229, 1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2) + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Initialize price chart
        function initPriceChart(priceData) {
            if (!priceData || priceData.length === 0) {
                return;
            }
            
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // Prepare data
            const labels = priceData.map(item => new Date(item.timestamp).toLocaleDateString());
            const prices = priceData.map(item => item.close);
            const volumes = priceData.map(item => item.volume);
            
            // Create chart
            if (chartInstances.price) {
                chartInstances.price.destroy();
            }
            
            chartInstances.price = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Price',
                            data: prices,
                            backgroundColor: 'rgba(30, 136, 229, 0.2)',
                            borderColor: 'rgba(30, 136, 229, 1)',
                            borderWidth: 2,
                            tension: 0.1,
                            yAxisID: 'y',
                            fill: false
                        },
                        {
                            label: 'Volume',
                            data: volumes,
                            backgroundColor: 'rgba(38, 166, 154, 0.5)',
                            borderColor: 'rgba(38, 166, 154, 1)',
                            borderWidth: 1,
                            type: 'bar',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        if (context.dataset.label === 'Price') {
                                            label += formatCurrency(context.parsed.y);
                                        } else if (context.dataset.label === 'Volume') {
                                            label += context.parsed.y.toLocaleString();
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Initialize indicator charts
        function initIndicatorCharts(indicators) {
            if (!indicators) {
                return;
            }
            
            // Initialize RSI chart
            if (indicators.rsi_data && indicators.rsi_data.length > 0) {
                const rsiCtx = document.getElementById('rsiChart').getContext('2d');
                const rsiLabels = indicators.rsi_data.map(item => new Date(item.timestamp).toLocaleDateString());
                const rsiValues = indicators.rsi_data.map(item => item.value);
                
                if (chartInstances.rsi) {
                    chartInstances.rsi.destroy();
                }
                
                chartInstances.rsi = new Chart(rsiCtx, {
                    type: 'line',
                    data: {
                        labels: rsiLabels,
                        datasets: [{
                            label: 'RSI (14)',
                            data: rsiValues,
                            backgroundColor: 'rgba(255, 202, 40, 0.2)',
                            borderColor: 'rgba(255, 202, 40, 1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                min: 0,
                                max: 100,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    stepSize: 10
                                }
                            }
                        }
                    }
                });
            }
            
            // Initialize MACD chart
            if (indicators.macd_data && indicators.macd_data.length > 0) {
                const macdCtx = document.getElementById('macdChart').getContext('2d');
                const macdLabels = indicators.macd_data.map(item => new Date(item.timestamp).toLocaleDateString());
                const macdValues = indicators.macd_data.map(item => item.macd);
                const signalValues = indicators.macd_data.map(item => item.signal);
                const histValues = indicators.macd_data.map(item => item.histogram);
                
                if (chartInstances.macd) {
                    chartInstances.macd.destroy();
                }
                
                chartInstances.macd = new Chart(macdCtx, {
                    type: 'line',
                    data: {
                        labels: macdLabels,
                        datasets: [
                            {
                                label: 'MACD',
                                data: macdValues,
                                backgroundColor: 'rgba(30, 136, 229, 0.2)',
                                borderColor: 'rgba(30, 136, 229, 1)',
                                borderWidth: 2,
                                tension: 0.1,
                                fill: false
                            },
                            {
                                label: 'Signal',
                                data: signalValues,
                                backgroundColor: 'rgba(239, 83, 80, 0.2)',
                                borderColor: 'rgba(239, 83, 80, 1)',
                                borderWidth: 2,
                                tension: 0.1,
                                fill: false
                            },
                            {
                                label: 'Histogram',
                                data: histValues,
                                backgroundColor: function(context) {
                                    const value = context.dataset.data[context.dataIndex];
                                    return value >= 0 ? 'rgba(102, 187, 106, 0.5)' : 'rgba(239, 83, 80, 0.5)';
                                },
                                borderColor: function(context) {
                                    const value = context.dataset.data[context.dataIndex];
                                    return value >= 0 ? 'rgba(102, 187, 106, 1)' : 'rgba(239, 83, 80, 1)';
                                },
                                borderWidth: 1,
                                type: 'bar'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Set up event handlers for symbol details
        function setupSymbolDetailsEventHandlers(symbol, data) {
            // Close position button
            $('.close-position-btn').click(function() {
                if (confirm(`Are you sure you want to close your position in ${symbol}?`)) {
                    $.ajax({
                        url: '/api/positions/close',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ symbol: symbol }),
                        success: function(response) {
                            showNotification('Position Closed', `${symbol} position closed successfully`, 'success');
                            loadSymbolDetails(symbol); // Refresh symbol details
                        },
                        error: function(xhr, status, error) {
                            console.error('Error closing position:', error);
                            showNotification('Error', `Failed to close ${symbol} position`, 'error');
                        }
                    });
                }
            });
            
            // Open position buttons
            $('.open-position-btn').click(function() {
                const side = $(this).data('side');
                
                // Show order modal
                $('#actionModalTitle').text(`Place ${side.toUpperCase()} Order for ${symbol}`);
                
                const modalContent = `
                    <form id="orderForm">
                        <div class="mb-3">
                            <label for="orderType" class="form-label">Order Type</label>
                            <select class="form-select" id="orderType">
                                <option value="market">Market</option>
                                <option value="limit">Limit</option>
                                <option value="stop">Stop</option>
                                <option value="stop_limit">Stop Limit</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="orderQty" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="orderQty" min="1" value="1">
                        </div>
                        <div class="mb-3 limit-price-group" style="display: none;">
                            <label for="limitPrice" class="form-label">Limit Price</label>
                            <input type="number" class="form-control" id="limitPrice" step="0.01" value="${data.price.toFixed(2)}">
                        </div>
                        <div class="mb-3 stop-price-group" style="display: none;">
                            <label for="stopPrice" class="form-label">Stop Price</label>
                            <input type="number" class="form-control" id="stopPrice" step="0.01" value="${data.price.toFixed(2)}">
                        </div>
                    </form>
                `;
                
                $('#actionModalBody').html(modalContent);
                $('#actionModalConfirm').text('Place Order');
                
                // Show/hide price fields based on order type
                $('#orderType').change(function() {
                    const orderType = $(this).val();
                    $('.limit-price-group').toggle(orderType === 'limit' || orderType === 'stop_limit');
                    $('.stop-price-group').toggle(orderType === 'stop' || orderType === 'stop_limit');
                });
                
                // Set up confirm button
                $('#actionModalConfirm').off('click').on('click', function() {
                    const orderType = $('#orderType').val();
                    const qty = $('#orderQty').val();
                    const limitPrice = $('#limitPrice').val() || null;
                    const stopPrice = $('#stopPrice').val() || null;
                    
                    const orderData = {
                        symbol: symbol,
                        side: side,
                        type: orderType,
                        qty: qty
                    };
                    
                    if (limitPrice) orderData.limit_price = limitPrice;
                    if (stopPrice) orderData.stop_price = stopPrice;
                    
                    $.ajax({
                        url: '/api/orders/place',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(orderData),
                        success: function(response) {
                            actionModal.hide();
                            showNotification('Order Placed', `${side.toUpperCase()} order for ${symbol} placed successfully`, 'success');
                            loadSymbolDetails(symbol); // Refresh symbol details
                        },
                        error: function(xhr, status, error) {
                            console.error('Error placing order:', error);
                            showNotification('Error', `Failed to place order for ${symbol}`, 'error');
                        }
                    });
                });
                
                actionModal.show();
            });
            
            // Place order button
            $('#placeOrderBtn').click(function() {
                const side = data.position ? (parseFloat(data.position.qty) > 0 ? 'sell' : 'buy') : 'buy';
                
                // Show order modal
                $('#actionModalTitle').text(`Place Order for ${symbol}`);
                
                const modalContent = `
                    <form id="orderForm">
                        <div class="mb-3">
                            <label for="orderSide" class="form-label">Side</label>
                            <select class="form-select" id="orderSide">
                                <option value="buy">Buy</option>
                                <option value="sell">Sell</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="orderType" class="form-label">Order Type</label>
                            <select class="form-select" id="orderType">
                                <option value="market">Market</option>
                                <option value="limit">Limit</option>
                                <option value="stop">Stop</option>
                                <option value="stop_limit">Stop Limit</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="orderQty" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="orderQty" min="1" value="1">
                        </div>
                        <div class="mb-3 limit-price-group" style="display: none;">
                            <label for="limitPrice" class="form-label">Limit Price</label>
                            <input type="number" class="form-control" id="limitPrice" step="0.01" value="${data.price.toFixed(2)}">
                        </div>
                        <div class="mb-3 stop-price-group" style="display: none;">
                            <label for="stopPrice" class="form-label">Stop Price</label>
                            <input type="number" class="form-control" id="stopPrice" step="0.01" value="${data.price.toFixed(2)}">
                        </div>
                    </form>
                `;
                
                $('#actionModalBody').html(modalContent);
                $('#actionModalConfirm').text('Place Order');
                
                // Set default side
                $('#orderSide').val(side);
                
                // Show/hide price fields based on order type
                $('#orderType').change(function() {
                    const orderType = $(this).val();
                    $('.limit-price-group').toggle(orderType === 'limit' || orderType === 'stop_limit');
                    $('.stop-price-group').toggle(orderType === 'stop' || orderType === 'stop_limit');
                });
                
                // Set up confirm button
                $('#actionModalConfirm').off('click').on('click', function() {
                    const orderSide = $('#orderSide').val();
                    const orderType = $('#orderType').val();
                    const qty = $('#orderQty').val();
                    const limitPrice = $('#limitPrice').val() || null;
                    const stopPrice = $('#stopPrice').val() || null;
                    
                    const orderData = {
                        symbol: symbol,
                        side: orderSide,
                        type: orderType,
                        qty: qty
                    };
                    
                    if (limitPrice) orderData.limit_price = limitPrice;
                    if (stopPrice) orderData.stop_price = stopPrice;
                    
                    $.ajax({
                        url: '/api/orders/place',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(orderData),
                        success: function(response) {
                            actionModal.hide();
                            showNotification('Order Placed', `${orderSide.toUpperCase()} order for ${symbol} placed successfully`, 'success');
                            loadSymbolDetails(symbol); // Refresh symbol details
                        },
                        error: function(xhr, status, error) {
                            console.error('Error placing order:', error);
                            showNotification('Error', `Failed to place order for ${symbol}`, 'error');
                        }
                    });
                });
                
                actionModal.show();
            });
            
            // Cancel order button
            $('.cancel-order-btn').click(function() {
                const orderId = $(this).data('order-id');
                if (confirm('Are you sure you want to cancel this order?')) {
                    $.ajax({
                        url: '/api/orders/cancel',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ order_id: orderId }),
                        success: function(response) {
                            showNotification('Order Cancelled', 'Order cancelled successfully', 'success');
                            loadSymbolDetails(symbol); // Refresh symbol details
                        },
                        error: function(xhr, status, error) {
                            console.error('Error cancelling order:', error);
                            showNotification('Error', 'Failed to cancel order', 'error');
                        }
                    });
                }
            });
            
            // Timeframe buttons
            $('.timeframe-btn').click(function() {
                $('.timeframe-btn').removeClass('active');
                $(this).addClass('active');
                
                const timeframe = $(this).data('timeframe');
                loadPriceChart(symbol, timeframe);
            });
        }
        
        // Load price chart with specific timeframe
        function loadPriceChart(symbol, timeframe) {
            $.ajax({
                url: `/api/symbol/${symbol}/prices`,
                method: 'GET',
                data: { timeframe: timeframe },
                success: function(data) {
                    initPriceChart(data);
                },
                error: function(xhr, status, error) {
                    console.error(`Error fetching ${symbol} prices:`, error);
                    showNotification('Error', `Failed to load price data for ${symbol}`, 'error');
                }
            });
        }
        
        // Load portfolio view
        function loadPortfolio() {
            $('#mainContent').html('<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">Loading portfolio data...</p></div>');
            
            // We'll implement the portfolio content in a future part
        }
        
        // Load backtest view
        function loadBacktest() {
            $('#mainContent').html('<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">Loading backtest interface...</p></div>');
            
            // We'll implement the backtest content in a future part
        }
        
        // Load orders view
        function loadOrders() {
            $('#mainContent').html('<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">Loading orders...</p></div>');
            
            // We'll implement the orders content in a future part
        }
    </script>
</body>
</html>