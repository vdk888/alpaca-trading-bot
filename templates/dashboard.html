<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        body {
            padding-top: 20px;
            background-color: #f5f5f5;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            font-weight: bold;
        }
        .price-up {
            color: green;
        }
        .price-down {
            color: red;
        }
        .dashboard-title {
            margin-bottom: 30px;
        }
        .signal-buy {
            background-color: rgba(0, 128, 0, 0.1);
        }
        .signal-sell {
            background-color: rgba(255, 0, 0, 0.1);
        }
        #chartContainer {
            height: 400px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center dashboard-title">Trading Bot Dashboard</h1>
        
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">Active Symbols</div>
                    <div class="card-body">
                        <div class="list-group" id="symbolList">
                            {% for symbol in active_symbols %}
                            <a href="#" class="list-group-item list-group-item-action symbol-item" data-symbol="{{ symbol }}">
                                {{ symbol }}
                                <span class="float-end" id="price-{{ symbol }}">Loading...</span>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">Portfolio Status</div>
                    <div class="card-body">
                        <div id="portfolioStatus">
                            <p>Total Value: <span id="portfolioValue">Loading...</span></p>
                            <p>Cash: <span id="portfolioCash">Loading...</span></p>
                            <p>Today's P&L: <span id="portfolioPnL">Loading...</span></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header">
                        <span id="selectedSymbolHeader">Price Chart</span>
                        <span class="float-end" id="lastUpdate"></span>
                    </div>
                    <div class="card-body">
                        <div id="chartContainer">
                            <canvas id="priceChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Signal Data</div>
                            <div class="card-body">
                                <div id="signalData">
                                    <table class="table table-sm">
                                        <tr>
                                            <td>Daily Composite:</td>
                                            <td id="dailyComposite">-</td>
                                        </tr>
                                        <tr>
                                            <td>Daily Upper Limit:</td>
                                            <td id="dailyUpperLimit">-</td>
                                        </tr>
                                        <tr>
                                            <td>Daily Lower Limit:</td>
                                            <td id="dailyLowerLimit">-</td>
                                        </tr>
                                        <tr>
                                            <td>Weekly Composite:</td>
                                            <td id="weeklyComposite">-</td>
                                        </tr>
                                        <tr>
                                            <td>Weekly Upper Limit:</td>
                                            <td id="weeklyUpperLimit">-</td>
                                        </tr>
                                        <tr>
                                            <td>Weekly Lower Limit:</td>
                                            <td id="weeklyLowerLimit">-</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Recent Signals</div>
                            <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                                <div id="recentSignals">
                                    <p>Loading signals...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">Recent Trades</div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-striped table-sm" id="tradesTable">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Symbol</th>
                                    <th>Type</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody id="tradesTableBody">
                                <tr>
                                    <td colspan="6" class="text-center">No recent trades</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let priceChart = null;
        let priceHistory = {};
        let activeSymbol = null;
        
        // Initialize on document ready
        $(document).ready(function() {
            // Get active symbols
            $.getJSON('/api/symbols', function(data) {
                const symbols = data.symbols;
                if (symbols.length > 0) {
                    // Load first symbol by default
                    activeSymbol = symbols[0];
                    loadSymbolData(activeSymbol);
                    
                    // Set up refresh interval
                    setInterval(function() {
                        if (activeSymbol) {
                            loadSymbolData(activeSymbol);
                        }
                    }, 5000);  // Refresh every 5 seconds
                }
            });
            
            // Start price updates
            updatePrices();
            
            // Update portfolio
            updatePortfolio();
            
            // Update signals
            updateSignals();
        });
        
        // Function to load symbol data
        function loadSymbolData(symbol) {
            $.getJSON(`/api/data/${symbol}`, function(data) {
                // Update the active symbol
                activeSymbol = symbol;
                
                // Update price chart title
                $('#priceChartTitle').text(`Price Chart: ${symbol}`);
                
                // Store price history
                if (data.price_history && Array.isArray(data.price_history)) {
                    console.log(`Received price history for ${symbol}: ${data.price_history.length} points`);
                    console.log("First few price points:", data.price_history.slice(0, 3));
                    
                    priceHistory[symbol] = data.price_history.map(item => ({
                        timestamp: item.timestamp,
                        price: item.price,
                        signal: item.signal || null
                    }));
                } else {
                    console.warn(`No price history received for ${symbol}`);
                    priceHistory[symbol] = [];
                }
                
                // Update price chart
                updatePriceChart(symbol);
                
                // Update signal data
                updateSignalData(data);
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.error(`Error loading data for ${symbol}:`, textStatus, errorThrown);
            });
        }
        
        // Function to update price chart
        function updatePriceChart(symbol) {
            if (!priceHistory[symbol] || priceHistory[symbol].length === 0) {
                console.log(`No price history available for ${symbol}`);
                return;
            }
            
            console.log(`Updating price chart for ${symbol} with ${priceHistory[symbol].length} data points`);
            console.log("Price history data:", priceHistory[symbol]);
            
            const chartData = priceHistory[symbol];
            
            // Make sure we have valid timestamps
            chartData.forEach(point => {
                if (typeof point.timestamp === 'string') {
                    try {
                        // Try to parse the timestamp
                        new Date(point.timestamp);
                    } catch (e) {
                        console.error(`Invalid timestamp: ${point.timestamp}`, e);
                        point.timestamp = new Date().toISOString();
                    }
                }
            });
            
            // Sort data by timestamp
            chartData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            const labels = chartData.map(d => {
                const date = new Date(d.timestamp);
                // Format date as MM/DD HH:MM
                return `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            });
            
            const prices = chartData.map(d => d.price);
            
            // Extract buy and sell signals
            const buySignals = [];
            const sellSignals = [];
            
            chartData.forEach((d, index) => {
                if (d.signal === 'buy') {
                    buySignals.push({
                        x: index,
                        y: d.price
                    });
                } else if (d.signal === 'sell') {
                    sellSignals.push({
                        x: index,
                        y: d.price
                    });
                }
            });
            
            if (priceChart) {
                priceChart.destroy();
            }
            
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: `${symbol} Price`,
                            data: prices,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1,
                            fill: false,
                            pointRadius: 1,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Price ($)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
            
            // Add buy signals as separate points
            if (buySignals.length > 0) {
                priceChart.data.datasets.push({
                    label: 'Buy Signals',
                    data: buySignals.map((point, i) => ({
                        x: labels[point.x],
                        y: point.y
                    })),
                    backgroundColor: 'green',
                    borderColor: 'green',
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    showLine: false
                });
            }
            
            // Add sell signals as separate points
            if (sellSignals.length > 0) {
                priceChart.data.datasets.push({
                    label: 'Sell Signals',
                    data: sellSignals.map((point, i) => ({
                        x: labels[point.x],
                        y: point.y
                    })),
                    backgroundColor: 'red',
                    borderColor: 'red',
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    showLine: false
                });
            }
            
            priceChart.update();
            console.log("Chart updated with price data and signals");
        }
        
        // Function to update prices
        function updatePrices() {
            $.getJSON('/api/prices', function(data) {
                $.each(data, function(symbol, price) {
                    const priceElement = $(`#price-${symbol}`);
                    if (priceElement.length) {
                        priceElement.text(`$${parseFloat(price).toFixed(2)}`);
                    }
                });
            })
                .catch(error => console.error('Error fetching prices:', error))
                .finally(() => {
                    // Schedule next update
                    setTimeout(updatePrices, 5000);  // Every 5 seconds
                });
        }
        
        // Function to update portfolio
        function updatePortfolio() {
            fetch('/api/portfolio')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const latest = data[data.length - 1];
                        document.getElementById('portfolioValue').textContent = `$${latest.total_value.toFixed(2)}`;
                        document.getElementById('portfolioCash').textContent = `$${latest.cash.toFixed(2)}`;
                        
                        const pnl = latest.today_pnl;
                        const pnlElement = document.getElementById('portfolioPnL');
                        pnlElement.textContent = `$${Math.abs(pnl).toFixed(2)} ${pnl >= 0 ? '▲' : '▼'}`;
                        pnlElement.className = pnl >= 0 ? 'price-up' : 'price-down';
                    }
                })
                .catch(error => console.error('Error fetching portfolio data:', error))
                .finally(() => {
                    // Schedule next update
                    setTimeout(updatePortfolio, 30000);  // Every 30 seconds
                });
        }
        
        // Function to update signals
        function updateSignals() {
            fetch('/api/signals')
                .then(response => response.json())
                .then(data => {
                    const signalsContainer = document.getElementById('recentSignals');
                    if (data.length === 0) {
                        signalsContainer.innerHTML = '<p>No signals yet</p>';
                        return;
                    }
                    
                    let html = '';
                    const recentSignals = data.slice(-5).reverse();  // Show 5 most recent signals
                    
                    recentSignals.forEach(signal => {
                        const signalClass = signal.signal === 1 ? 'signal-buy' : 'signal-sell';
                        const signalType = signal.signal === 1 ? 'BUY' : 'SELL';
                        const time = new Date(signal.timestamp).toLocaleString();
                        
                        html += `
                            <div class="alert ${signalClass} mb-2 py-2">
                                <strong>${signal.symbol} - ${signalType}</strong> at $${signal.price.toFixed(2)}<br>
                                <small>${time}</small>
                            </div>
                        `;
                    });
                    
                    signalsContainer.innerHTML = html;
                })
                .catch(error => console.error('Error fetching signal data:', error))
                .finally(() => {
                    // Schedule next update
                    setTimeout(updateSignals, 10000);  // Every 10 seconds
                });
        }
        
        // Function to update recent trades
        function updateRecentTrades() {
            fetch('/api/signals')
                .then(response => response.json())
                .then(data => {
                    const tradesBody = document.getElementById('tradesTableBody');
                    if (data.length === 0) {
                        tradesBody.innerHTML = '<tr><td colspan="6" class="text-center">No recent trades</td></tr>';
                        return;
                    }
                    
                    let html = '';
                    const tradingSignals = data.filter(s => s.executed === true);
                    const recentTrades = tradingSignals.slice(-10).reverse();  // Show 10 most recent trades
                    
                    recentTrades.forEach(trade => {
                        const tradeType = trade.signal === 1 ? 'BUY' : 'SELL';
                        const typeClass = trade.signal === 1 ? 'text-success' : 'text-danger';
                        const time = new Date(trade.timestamp).toLocaleString();
                        
                        html += `
                            <tr>
                                <td>${time}</td>
                                <td>${trade.symbol}</td>
                                <td class="${typeClass}">${tradeType}</td>
                                <td>$${trade.price.toFixed(2)}</td>
                                <td>${trade.quantity?.toFixed(8) || '-'}</td>
                                <td>$${(trade.price * (trade.quantity || 0)).toFixed(2)}</td>
                            </tr>
                        `;
                    });
                    
                    if (html) {
                        tradesBody.innerHTML = html;
                    } else {
                        tradesBody.innerHTML = '<tr><td colspan="6" class="text-center">No executed trades yet</td></tr>';
                    }
                })
                .catch(error => console.error('Error fetching trade data:', error))
                .finally(() => {
                    // Schedule next update
                    setTimeout(updateRecentTrades, 10000);  // Every 10 seconds
                });
        }
    </script>
</body>
</html>