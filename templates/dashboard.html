<!DOCTYPE html>
<html>
<head>
    <title>Alpaca Trading Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- Use ApexCharts for candlestick charts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        .card { margin-bottom: 20px; }
        .indicator-value { font-weight: bold; }
        .positive { color: green; }
        .negative { color: red; }
        .neutral { color: gray; }
        .tab-content { padding: 20px 0; }
        .nav-tabs { margin-bottom: 20px; }
        .signal-strong { font-weight: bold; }
        .signal-buy { color: green; }
        .signal-sell { color: red; }
        .signal-neutral { color: gray; }
        .position-summary { font-size: 0.9rem; }
        .refresh-btn { cursor: pointer; }
        .symbol-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            margin-right: 0.5rem;
            font-weight: bold;
            background-color: #f8f9fa;
        }
        .market-open { color: green; }
        .market-closed { color: red; }
        #performance-chart {
            height: 300px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <!-- Hidden element to store config values -->
    <div id="config-data" data-interval-ms="{{ interval_ms }}" style="display: none;"></div>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Alpaca Trading Dashboard</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if not active_tab or active_tab == 'overview' %}active{% endif %}" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">Overview</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" href="/dashboard/positions">Positions</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" href="/dashboard/orders">Orders</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" href="/dashboard/backtest">Backtest</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="tab-content" id="myTabContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade {% if not active_tab or active_tab == 'overview' %}show active{% endif %}" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                <div class="row">
                    <!-- Account Balance -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Account Balance <i class="bi bi-arrow-clockwise refresh-btn" onclick="updateBalance()"></i></h5>
                            </div>
                            <div class="card-body" id="balance-info">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Today's Performance <i class="bi bi-arrow-clockwise refresh-btn" onclick="updatePerformance()"></i></h5>
                            </div>
                            <div class="card-body" id="performance-info">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Portfolio Graph -->
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Portfolio Performance <i class="bi bi-arrow-clockwise refresh-btn" onclick="updatePortfolioGraph()"></i></h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12">
                                <div id="portfolio-chart-container" style="height: 400px;">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div id="allocation-chart-container" style="height: 300px;">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Symbol Price Charts -->
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Symbol Price Charts <i class="bi bi-arrow-clockwise refresh-btn" onclick="updatePriceCharts()"></i></h5>
                        <div>
                            <select class="form-select" id="chart-days">
                                <option value="3" {% if lookback_days == 3 %}selected{% endif %}>3 Days</option>
                                <option value="7" {% if lookback_days == 7 %}selected{% endif %}>7 Days</option>
                                <option value="14" {% if lookback_days == 14 %}selected{% endif %}>14 Days</option>
                                <option value="30" {% if lookback_days == 30 %}selected{% endif %}>30 Days</option>
                                {% if not (lookback_days == 3 or lookback_days == 7 or lookback_days == 14 or lookback_days == 30) %}
                                <option value="{{ lookback_days }}" selected>{{ lookback_days }} Days (Trading Default)</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row" id="price-charts-container">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Performance Ranking -->
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Performance Ranking <i class="bi bi-arrow-clockwise refresh-btn" onclick="updateRank()"></i></h5>
                    </div>
                    <div class="card-body" id="rank-info">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Capital Multiplier History -->
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Capital Multiplier History <i class="bi bi-arrow-clockwise refresh-btn" onclick="updateCapitalMultiplier()"></i></h5>
                    </div>
                    <div class="card-body" id="capital-multiplier-info">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ensure annotation plugin is registered globally
        Chart.defaults.plugins.annotation = Chart.defaults.plugins.annotation || {};
        
        // Populate symbols dropdown
        const availableSymbols = JSON.parse('{{ symbols|tojson|safe }}');
        
        function populateSymbolDropdowns() {
            const symbolSelect = document.getElementById('symbol-select');
            
            // Clear existing options - add null checks
            if (symbolSelect) symbolSelect.innerHTML = '';
            
            // Add symbols to dropdowns
            availableSymbols.forEach(symbol => {
                // Strategy visualization dropdown
                if (symbolSelect) {
                    const option1 = document.createElement('option');
                    option1.value = symbol;
                    option1.text = symbol;
                    symbolSelect.appendChild(option1);
                }
            });
        }

        // Format number as currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
        }
        
        // Format number as percentage
        function formatPercentage(value) {
            return new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value/100);
        }
        
        // Format number with 2 decimal places
        function formatNumber(value) {
            return new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
        }
        
        // Get CSS class for positive/negative values
        function getValueClass(value) {
            return value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
        }
        
        // Get CSS class for signal
        function getSignalClass(signal) {
            if (signal.includes('STRONG BUY') || signal.includes('WEAK BUY')) {
                return 'signal-buy' + (signal.includes('STRONG') ? ' signal-strong' : '');
            } else if (signal.includes('STRONG SELL') || signal.includes('WEAK SELL')) {
                return 'signal-sell' + (signal.includes('STRONG') ? ' signal-strong' : '');
            } else {
                return 'signal-neutral';
            }
        }

        function sanitizeSymbolForId(symbol) {
            // Replace any non-alphanumeric characters with underscores
            return symbol.replace(/[^a-zA-Z0-9]/g, '_');
        }
        
        // Update functions
        function updateBalance() {
            $.get('/dashboard/api/balance', function(data) {
                if (data.error) {
                    $('#balance-info').html(`<div class="alert alert-danger">${data.error}</div>`);
                    return;
                }
                
                const todayPL = data.today_pl || 0;
                const todayPLClass = getValueClass(todayPL);
                
                const balanceHtml = `
                    <div class="row">
                        <div class="col-md-3">
                            <p>Cash: ${formatCurrency(data.cash)}</p>
                        </div>
                        <div class="col-md-3">
                            <p>Portfolio Value: ${formatCurrency(data.portfolio_value)}</p>
                        </div>
                        <div class="col-md-3">
                            <p>Buying Power: ${formatCurrency(data.buying_power)}</p>
                        </div>
                        <div class="col-md-3">
                            <p>Today's P&L: <span class="${todayPLClass}">${formatCurrency(todayPL)}</span></p>
                        </div>
                    </div>
                `;
                $('#balance-info').html(balanceHtml);
            });
        }
        
        function updatePerformance() {
            $.get('/dashboard/api/performance', function(data) {
                if (data.error) {
                    $('#performance-info').html(`<div class="alert alert-danger">${data.error}</div>`);
                    return;
                }
                
                const todayPLClass = getValueClass(data.today_pl);
                
                const performanceHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <p>Today's P&L: <span class="${todayPLClass}">${formatCurrency(data.today_pl)} (${formatPercentage(data.today_pl_pct)})</span></p>
                        </div>
                        <div class="col-md-6">
                            <p>Starting Equity: ${formatCurrency(data.starting_equity)}</p>
                            <p>Current Equity: ${formatCurrency(data.current_equity)}</p>
                        </div>
                    </div>
                `;
                $('#performance-info').html(performanceHtml);
            });
        }
        
        function updateMarkets() {
            $.get('/dashboard/api/markets', function(data) {
                if (Object.keys(data).length === 0) {
                    $('#markets-info').html(`<div class="alert alert-warning">No market data available</div>`);
                    return;
                }
                
                let marketsHtml = '<div class="row">';
                
                for (const [symbol, info] of Object.entries(data)) {
                    if (info.error) continue;
                    
                    const statusClass = info.is_open ? 'market-open' : 'market-closed';
                    const statusText = info.is_open ? 'Open' : 'Closed';
                    
                    marketsHtml += `
                        <div class="col-md-3 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6>${symbol} (${info.name})</h6>
                                    <p>Exchange: ${info.exchange}</p>
                                    <p>Status: <span class="${statusClass}">${statusText}</span></p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                marketsHtml += '</div>';
                $('#markets-info').html(marketsHtml);
            });
        }

        function updateStatus() {
            $.get('/dashboard/api/status', function(data) {
                if (Object.keys(data).length === 0) {
                    $('#status-info').html(`<div class="alert alert-warning">No status data available</div>`);
                    return;
                }
                
                let statusHtml = '<div class="row">';
                
                for (const [symbol, info] of Object.entries(data)) {
                    if (info.error) continue;
                    
                    const dailyCompositeClass = getValueClass(info.daily_composite);
                    const weeklyCompositeClass = getValueClass(info.weekly_composite);
                    const price5mClass = getValueClass(info.price_change_5m);
                    const price1hClass = getValueClass(info.price_change_1h);
                    
                    statusHtml += `
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6>${symbol} (${info.name})</h6>
                                </div>
                                <div class="card-body">
                                    <p>Position: <strong>${info.position}</strong></p>
                                    <p>Current Price: ${formatCurrency(info.current_price)}</p>
                                    <p>P&L: ${info.pos_pnl}</p>
                                    <p>Daily Composite: <span class="${dailyCompositeClass}">${formatNumber(info.daily_composite)}</span></p>
                                    <p>Weekly Composite: <span class="${weeklyCompositeClass}">${formatNumber(info.weekly_composite)}</span></p>
                                    <p>5m Change: <span class="${price5mClass}">${formatPercentage(info.price_change_5m)}</span></p>
                                    <p>1h Change: <span class="${price1hClass}">${formatPercentage(info.price_change_1h)}</span></p>
                                    <p>Parameters: ${info.params}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                statusHtml += '</div>';
                $('#status-info').html(statusHtml);
            });
        }
        
        function updateRank() {
            const days = parseInt($('#chart-days').val());
            console.log('updateRank called with days:', days);
            $.get(`/dashboard/api/rank?days=${days}`, function(data) {
                if (data.error) {
                    $('#rank-info').html(`<div class="alert alert-danger">${data.error}</div>`);
                    return;
                }
                
                // Create performance chart
                createPerformanceChart(data);
            });
        }
        
        function updateCapitalMultiplier() {
            const days = parseInt($('#chart-days').val());
            console.log('updateCapitalMultiplier called with days:', days);
            $.get(`/dashboard/api/capital-multiplier?days=${days}`, function(data) {
                if (data.error) {
                    $('#capital-multiplier-info').html(`<div class="alert alert-danger">${data.error}</div>`);
                    return;
                }
                
                // Create capital multiplier chart
                createCapitalMultiplierChart(data);
            });
        }
        
        function createPerformanceChart(data) {
            // Clear previous content
            $('#rank-info').empty();
            
            console.log('Performance data:', data);
            
            // Check if we have the performance data in the expected format
            if (!data || !data.performance || !Array.isArray(data.performance) || data.performance.length === 0) {
                console.warn('Performance data is not in expected format:', data);
                $('#rank-info').html('<div class="alert alert-warning">No performance data available</div>');
                return;
            }
            
            // Sort the performance data by return percentage (descending)
            const sortedPerformance = [...data.performance].sort((a, b) => b.return_pct - a.return_pct);
            
            // Create container for the bar chart and table
            const container = $('<div class="row"></div>');
            const chartCol = $('<div class="col-md-6"></div>');
            const tableCol = $('<div class="col-md-6"></div>');
            
            // Create canvas for the bar chart
            const canvas = $('<canvas></canvas>').attr('id', 'performance-bar-chart');
            chartCol.append(canvas);
            
            // Create table for the performance data
            const table = $(`
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Symbol</th>
                                <th>Return (%)</th>
                            </tr>
                        </thead>
                        <tbody id="performance-table-body">
                        </tbody>
                    </table>
                </div>
            `);
            tableCol.append(table);
            
            // Add both columns to the container
            container.append(chartCol);
            container.append(tableCol);
            
            // Add the container to the rank-info div
            $('#rank-info').append(container);
            
            // Populate the table
            const tableBody = $('#performance-table-body');
            sortedPerformance.forEach((item, index) => {
                const returnClass = item.return_pct >= 0 ? 'text-success' : 'text-danger';
                tableBody.append(`
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.symbol}</td>
                        <td class="${returnClass}">${item.return_pct.toFixed(2)}%</td>
                    </tr>
                `);
            });
            
            // Create the bar chart
            const ctx = document.getElementById('performance-bar-chart').getContext('2d');
            const labels = sortedPerformance.map(item => item.symbol);
            const returns = sortedPerformance.map(item => item.return_pct);
            const backgroundColors = returns.map(value => 
                value >= 0 ? 'rgba(75, 192, 75, 0.7)' : 'rgba(255, 99, 132, 0.7)'
            );
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Return (%)',
                        data: returns,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',  // Horizontal bar chart
                    plugins: {
                        title: {
                            display: true,
                            text: `${data.days}-Day Performance Ranking`
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Return (%)'
                            }
                        }
                    }
                }
            });
        }
        
        function createCapitalMultiplierChart(data) {
            // Clear previous content
            $('#capital-multiplier-info').empty();
            
            console.log('Capital Multiplier data:', data);
            
            // Check if we have the data in the expected format
            if (!data || !data.dates || !data.multiplier || !Array.isArray(data.dates) || data.dates.length === 0) {
                console.warn('Capital Multiplier data is not in expected format:', data);
                $('#capital-multiplier-info').html('<div class="alert alert-warning">No capital multiplier data available</div>');
                return;
            }
            
            // Create container for the line chart and current value
            const container = $('<div class="row"></div>');
            
            // Add current multiplier value at the top
            if (data.current_multiplier) {
                const currentValueCol = $('<div class="col-md-12 mb-3"></div>');
                const currentValueAlert = $(`
                    <div class="alert ${data.current_multiplier > 1.5 ? 'alert-success' : 'alert-warning'}">
                        <strong>Current Capital Multiplier: ${data.current_multiplier}x</strong> 
                        (Using ${data.lookback_days.toFixed(1)} days lookback for calculation)
                    </div>
                `);
                currentValueCol.append(currentValueAlert);
                container.append(currentValueCol);
            }
            
            const chartCol = $('<div class="col-md-12"></div>');
            
            // Create canvas for the line chart
            const canvas = $('<canvas></canvas>').attr('id', 'capital-multiplier-chart').css('height', '400px');
            chartCol.append(canvas);
            
            // Add column to the container
            container.append(chartCol);
            
            // Add the container to the capital-multiplier-info div
            $('#capital-multiplier-info').append(container);
            
            // Create the line chart
            const ctx = document.getElementById('capital-multiplier-chart').getContext('2d');
            
            // Calculate upper and lower bounds based on standard deviation
            const upperBound = data.multiplier.map((val, idx) => Math.min(3.0, val + data.std[idx]));
            const lowerBound = data.multiplier.map((val, idx) => Math.max(0.5, val - data.std[idx]));
            
            // Add a reference line dataset for the neutral value (1.5)
            const neutralLine = Array(data.dates.length).fill(1.5);
            
            // Add a vertical line for today (last data point)
            // We'll use a separate dataset with a single point for the current date
            const todayMarker = Array(data.dates.length).fill(null);
            if (data.dates.length > 0) {
                todayMarker[todayMarker.length - 1] = data.multiplier[data.multiplier.length - 1];
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [
                        {
                            label: 'Capital Multiplier',
                            data: data.multiplier,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'Upper Bound (+1 STD)',
                            data: upperBound,
                            borderColor: 'rgba(75, 192, 75, 0.5)',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'Lower Bound (-1 STD)',
                            data: lowerBound,
                            borderColor: 'rgba(255, 99, 132, 0.5)',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'Upper 2STD',
                            data: data.daily_up_lim_2std,
                            borderColor: 'rgba(75, 192, 75, 0.6)',
                            borderWidth: 1,
                            borderDash: [2, 2],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Lower 2STD',
                            data: data.daily_down_lim_2std,
                            borderColor: 'rgba(255, 99, 132, 0.6)',
                            borderWidth: 1,
                            borderDash: [2, 2],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Neutral (1.5x)',
                            data: neutralLine,
                            borderColor: 'rgba(128, 128, 128, 0.5)',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            tension: 0.0,
                            fill: false
                        },
                        {
                            label: 'Today',
                            data: todayMarker,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 0,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            fill: false,
                            showLine: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Capital Multiplier Evolution'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: false,
                            grace: '5%', // Add some space at the top and bottom
                            title: {
                                display: true,
                                text: 'Multiplier Value'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + 'x';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });
            
            // Add a description of what the capital multiplier means
            const description = $(`
                <div class="mt-3">
                    <p><strong>Capital Multiplier:</strong> A dynamic factor (0.5x to 3.0x) that adjusts position sizes based on market conditions.</p>
                    <ul>
                        <li>Higher values (>1.5x) indicate favorable market conditions for increased exposure</li>
                        <li>Lower values (<1.5x) suggest caution and reduced position sizes</li>
                        <li>The dotted lines represent the standard deviation bounds</li>
                        <li>This multiplier is used in the trading algorithm to dynamically adjust position sizes</li>
                    </ul>
                    <p><small>Note: The trading system uses a lookback period of ${data.lookback_days ? data.lookback_days.toFixed(1) : '?'} days to calculate the current multiplier value.</small></p>
                </div>
            `);
            $('#capital-multiplier-info').append(description);
        }
        
        function updatePriceCharts() {
            const days = parseInt($('#chart-days').val());
            console.log('updatePriceCharts called with days:', days);
            const container = $('#price-charts-container');
            container.html('<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>');
            
            // Fetch symbols first
            $.ajax({
                url: '/dashboard/api/symbols',
                method: 'GET',
                success: function(data) {
                    container.empty();
                    
                    // Create a row with columns for each symbol
                    data.forEach(function(symbolData) {
                        // Use the original symbol key for API calls
                        const symbol = symbolData.symbol;
                        const safeSymbolId = sanitizeSymbolForId(symbol);
                        
                        // Create a column for each symbol
                        const col = $('<div class="col-md-6 col-lg-6 mb-4"></div>');
                        const card = $('<div class="card h-100"></div>');
                        const cardBody = $('<div class="card-body p-2"></div>');
                        const chartContainer = $('<div class="chart-container" style="position: relative; height: 850px; width: 100%;"></div>');
                        const canvas = $('<canvas></canvas>').attr('id', 'price-chart-' + safeSymbolId);
                        
                        chartContainer.append(canvas);
                        cardBody.append(chartContainer);
                        card.append(cardBody);
                        col.append(card);
                        container.append(col);
                        
                        // Fetch price data for this symbol with the current days value
                        fetchPriceData(symbol, safeSymbolId, days);
                    });
                },
                error: function(error) {
                    container.html('<div class="alert alert-danger">Error loading symbols: ' + (error.responseJSON?.error || 'Unknown error') + '</div>');
                }
            });
        }
        
        function fetchPriceData(symbol, safeSymbolId, days) {
            console.log('fetchPriceData called for symbol:', symbol, 'with days:', days);
            $.ajax({
                url: '/dashboard/api/price-data',
                method: 'GET',
                data: {
                    symbol: symbol,
                    days: days
                },
                success: function(data) {
                    console.log('Price data received for', symbol, 'with days:', data.days);
                    createPriceChart(symbol, safeSymbolId, data);
                },
                error: function(error) {
                    $('#price-chart-' + safeSymbolId).parent().html('<div class="alert alert-danger">Error loading price data: ' + (error.responseJSON?.error || 'Unknown error') + '</div>');
                }
            });
        }
        
        function createPriceChart(symbol, safeSymbolId, data) {
            // Create container for all charts related to this symbol
            const chartContainer = $('#price-chart-' + safeSymbolId).parent();
            chartContainer.empty();
            
            // Create a header div with title and download button
            const headerDiv = $('<div class="d-flex justify-content-between align-items-center mb-2"></div>');
            const titleElement = $('<h6 class="m-0">' + data.name + ' Price</h6>');
            const downloadButton = $('<button class="btn btn-sm btn-outline-secondary" title="Download data as CSV"><i class="bi bi-download"></i> CSV</button>');
            
            // Add click handler to download button
            downloadButton.on('click', function() {
                downloadSymbolData(symbol, data.days);
            });
            
            // Add Bootstrap Icons CSS if not already included
            if ($('link[href*="bootstrap-icons"]').length === 0) {
                $('head').append('<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">');
            }
            
            // Add title and button to header
            headerDiv.append(titleElement);
            headerDiv.append(downloadButton);
            
            // Add header to chart container
            chartContainer.append(headerDiv);
            
            // Increase the height of the chart container to fit all four charts with proper spacing
            chartContainer.css('height', '850px');
            
            // Create div containers for each chart to ensure proper spacing
            const priceChartDiv = $('<div style="height: 220px; margin-bottom: 30px;"></div>').attr('id', 'price-chart-container-' + safeSymbolId);
            const dailyChartDiv = $('<div style="height: 130px; margin-bottom: 30px;"></div>');
            const weeklyChartDiv = $('<div style="height: 130px; margin-bottom: 30px;"></div>');
            const portfolioChartDiv = $('<div style="height: 150px; margin-bottom: 20px;"></div>');
            
            // Create canvas elements for indicator charts
            const dailyCanvas = $('<canvas></canvas>').attr('id', 'daily-indicator-chart-' + safeSymbolId);
            const weeklyCanvas = $('<canvas></canvas>').attr('id', 'weekly-indicator-chart-' + safeSymbolId);
            const portfolioCanvas = $('<canvas></canvas>').attr('id', 'portfolio-backtest-chart-' + safeSymbolId);
            
            // Add canvases to their respective divs
            dailyChartDiv.append(dailyCanvas);
            weeklyChartDiv.append(weeklyCanvas);
            portfolioChartDiv.append(portfolioCanvas);
            
            // Add titles for each chart
            const dailyTitle = $('<h6 class="text-center mt-3 mb-1">Daily Composite Indicator</h6>');
            const weeklyTitle = $('<h6 class="text-center mt-3 mb-1">Weekly Composite Indicator</h6>');
            const portfolioTitle = $('<h6 class="text-center mt-3 mb-1">Backtest Portfolio Value</h6>');
            
            // Add all divs to the container
            chartContainer.append(priceChartDiv);
            chartContainer.append(dailyTitle);
            chartContainer.append(dailyChartDiv);
            chartContainer.append(weeklyTitle);
            chartContainer.append(weeklyChartDiv);
            chartContainer.append(portfolioTitle);
            chartContainer.append(portfolioChartDiv);
            
            // 1. Create Price Chart with Candlesticks using ApexCharts
            const ohlcData = data.ohlc.map(item => {
                return {
                    x: new Date(item.x).getTime(),
                    y: [item.o, item.h, item.l, item.c]
                };
            });
            
            // Create series for buy and sell signals
            const buySeries = [];
            const sellSeries = [];
            
            // Process buy signals if available
            if (data.buy_signals && data.buy_signals.length > 0) {
                data.buy_signals.forEach(signal => {
                    buySeries.push({
                        x: new Date(signal.time).getTime(),
                        y: signal.price,
                        marker: {
                            size: 8,
                            fillColor: '#00B746',
                            strokeColor: '#00B746',
                            shape: 'triangle'
                        },
                        label: {
                            text: '$' + signal.price.toFixed(2),
                            style: {
                                color: '#00B746',
                                fontSize: '10px'
                            },
                            offsetY: 10
                        }
                    });
                });
            }
            
            // Process sell signals if available
            if (data.sell_signals && data.sell_signals.length > 0) {
                data.sell_signals.forEach(signal => {
                    sellSeries.push({
                        x: new Date(signal.time).getTime(),
                        y: signal.price,
                        marker: {
                            size: 8,
                            fillColor: '#FF4560',
                            strokeColor: '#FF4560',
                            shape: 'triangle',
                            radius: 5,
                            offsetY: -5
                        },
                        label: {
                            text: '$' + signal.price.toFixed(2),
                            style: {
                                color: '#FF4560',
                                fontSize: '10px'
                            },
                            offsetY: -10
                        }
                    });
                });
            }
            
            const options = {
                series: [
                    {
                        name: data.name,
                        type: 'candlestick',
                        data: ohlcData
                    },
                    {
                        name: 'Buy Signal',
                        type: 'scatter',
                        data: buySeries
                    },
                    {
                        name: 'Sell Signal',
                        type: 'scatter',
                        data: sellSeries
                    }
                ],
                chart: {
                    height: 250,
                    type: 'candlestick',
                    toolbar: {
                        show: false
                    }
                },
                title: {
                    text: data.name + ' Price',
                    align: 'left'
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        datetimeUTC: false,
                        format: 'MMM dd'
                    }
                },
                yaxis: {
                    tooltip: {
                        enabled: true
                    },
                    title: {
                        text: 'Price (USD)'
                    },
                    labels: {
                        formatter: function(value) {
                            // Format to a maximum of 6 decimal places, removing trailing zeros
                            return parseFloat(value.toFixed(6)).toString();
                        }
                    }
                },
                plotOptions: {
                    candlestick: {
                        colors: {
                            upward: '#3C90EB',
                            downward: '#DF7D46'
                        },
                        wick: {
                            useFillColor: true
                        }
                    }
                },
                markers: {
                    size: [0, 6, 6], // Size for each series: candlestick (0), buy (6), sell (6)
                    shape: ['circle', 'triangle', 'triangle'],
                    radius: 2
                },
                annotations: {
                    points: []
                },
                tooltip: {
                    shared: false,
                    intersect: true
                },
                legend: {
                    show: true
                }
            };
            
            const priceChart = new ApexCharts(document.getElementById('price-chart-container-' + safeSymbolId), options);
            priceChart.render();
            
            // 2. Create Daily Composite Indicator Chart
            const dailyCtx = dailyCanvas.get(0).getContext('2d');
            new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Daily Composite',
                            data: data.daily_composite,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Upper Limit',
                            data: data.daily_up_lim,
                            borderColor: 'rgba(75, 192, 75, 0.8)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Lower Limit',
                            data: data.daily_down_lim,
                            borderColor: 'rgba(255, 99, 132, 0.8)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Upper 2STD',
                            data: data.daily_up_lim_2std,
                            borderColor: 'rgba(75, 192, 75, 0.6)',
                            borderWidth: 1,
                            borderDash: [2, 2],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Lower 2STD',
                            data: data.daily_down_lim_2std,
                            borderColor: 'rgba(255, 99, 132, 0.6)',
                            borderWidth: 1,
                            borderDash: [2, 2],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 5,
                            right: 10,
                            bottom: 5,
                            left: 10
                        }
                    },
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            position: 'top',
                            align: 'center',
                            labels: {
                                boxWidth: 8,
                                padding: 5,
                                font: {
                                    size: 9
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: false // Hide x-axis labels
                        },
                        y: {
                            display: true,
                            beginAtZero: false,
                            grace: '10%', // Add some space at the top and bottom
                            ticks: {
                                font: {
                                    size: 9
                                },
                                padding: 3
                            }
                        }
                    }
                }
            });
            
            // 3. Create Weekly Composite Indicator Chart
            const weeklyCtx = weeklyCanvas.get(0).getContext('2d');
            new Chart(weeklyCtx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Weekly Composite',
                            data: data.weekly_composite,
                            borderColor: 'rgba(153, 102, 255, 1)',
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Upper Limit',
                            data: data.weekly_up_lim,
                            borderColor: 'rgba(75, 192, 75, 0.8)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Lower Limit',
                            data: data.weekly_down_lim,
                            borderColor: 'rgba(255, 99, 132, 0.8)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Upper 2STD',
                            data: data.weekly_up_lim_2std,
                            borderColor: 'rgba(75, 192, 75, 0.6)',
                            borderWidth: 1,
                            borderDash: [2, 2],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Lower 2STD',
                            data: data.weekly_down_lim_2std,
                            borderColor: 'rgba(255, 99, 132, 0.6)',
                            borderWidth: 1,
                            borderDash: [2, 2],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 5,
                            right: 10,
                            bottom: 5,
                            left: 10
                        }
                    },
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            position: 'top',
                            align: 'center',
                            labels: {
                                boxWidth: 8,
                                padding: 5,
                                font: {
                                    size: 9
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: false // Hide x-axis labels
                        },
                        y: {
                            display: true,
                            beginAtZero: false,
                            grace: '10%', // Add some space at the top and bottom
                            ticks: {
                                font: {
                                    size: 9
                                },
                                padding: 3
                            }
                        }
                    }
                }
            });
            
            // 4. Create Portfolio Value Chart from Backtest
            if (data.portfolio_values && data.portfolio_values.length > 0) {
                const portfolioCtx = portfolioCanvas.get(0).getContext('2d');
                
                // Determine if we have allocation percentage data
                const hasAllocationData = data.allocation_percentages && data.allocation_percentages.length > 0;
                
                // Create the chart with dual y-axes if we have allocation data
                new Chart(portfolioCtx, {
                    type: 'line',
                    data: {
                        labels: data.portfolio_dates || data.labels,
                        datasets: [
                            {
                                label: 'Portfolio Value ($)',
                                data: data.portfolio_values,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: true,
                                yAxisID: 'y'
                            },
                            // Add allocation percentage dataset if available
                            ...(hasAllocationData ? [{
                                label: 'Allocation (%)',
                                data: data.allocation_percentages,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderWidth: 1.5,
                                pointRadius: 0,
                                fill: false,
                                yAxisID: 'y1'
                            }] : [])
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 5,
                                right: 10,
                                bottom: 5,
                                left: 10
                            }
                        },
                        plugins: {
                            title: {
                                display: false
                            },
                            legend: {
                                position: 'top',
                                align: 'center',
                                labels: {
                                    boxWidth: 8,
                                    padding: 5,
                                    font: {
                                        size: 9
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.dataset.label === 'Portfolio Value ($)') {
                                            return 'Portfolio Value: $' + context.raw.toFixed(2);
                                        } else if (context.dataset.label === 'Allocation (%)') {
                                            return 'Allocation: ' + context.raw.toFixed(2) + '%';
                                        }
                                        return context.dataset.label + ': ' + context.raw;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: false // Hide x-axis labels as requested
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: false,
                                grace: '5%', // Add some space at the top and bottom
                                title: {
                                    display: true,
                                    text: 'Portfolio Value ($)',
                                    font: {
                                        size: 9
                                    },
                                    padding: {top: 0, bottom: 0}
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    },
                                    font: {
                                        size: 9
                                    },
                                    padding: 3
                                }
                            },
                            // Only add secondary y-axis if we have allocation data
                            ...(hasAllocationData ? {
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    beginAtZero: true,
                                    max: 100, // Maximum percentage is 100%
                                    grace: '5%',
                                    grid: {
                                        drawOnChartArea: false // Only show grid lines for left y-axis
                                    },
                                    title: {
                                        display: true,
                                        text: 'Allocation (%)',
                                        font: {
                                            size: 9
                                        },
                                        padding: {top: 0, bottom: 0}
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return value.toFixed(0) + '%';
                                        },
                                        font: {
                                            size: 9
                                        },
                                        padding: 3
                                    }
                                }
                            } : {})
                        }
                    }
                });
            } else {
                // If no portfolio data is available, show a message
                portfolioChartDiv.html('<div class="alert alert-info py-2">No backtest portfolio data available</div>');
            }
        }
        
        // Set up price chart days change handler
        $('#chart-days').change(function() {
            const days = $(this).val();
            console.log('chart-days changed to:', days);
            updatePriceCharts();
            updatePortfolioGraph();
        });
        
        // Function to update portfolio graph
        function updatePortfolioGraph() {
            showLoadingToast('Loading portfolio data...');
            
            const days = $('#chart-days').val();
            
            // Clear existing charts
            $('#portfolio-chart-container').html('<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>');
            $('#allocation-chart-container').html('<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>');
            
            // Fetch portfolio data
            $.ajax({
                url: `/dashboard/api/portfolio?days=${days}`,
                method: 'GET',
                success: function(data) {
                    hideLoadingToast();
                    
                    if (data.error) {
                        console.error('Error fetching portfolio data:', data.error);
                        $('#portfolio-chart-container').html(`<div class="alert alert-danger">Error: ${data.error}</div>`);
                        return;
                    }
                    
                    // Create portfolio chart
                    createPortfolioChart(data);
                    
                    // Create allocation chart
                    createAllocationChart(data);
                },
                error: function(xhr, status, error) {
                    hideLoadingToast();
                    console.error('AJAX error:', error);
                    $('#portfolio-chart-container').html(`<div class="alert alert-danger">Error: ${error}</div>`);
                }
            });
        }
        
        // Function to create portfolio chart
        function createPortfolioChart(data) {
            // Prepare data for ApexCharts
            const portfolioData = data.portfolio_data.map(item => ({
                x: new Date(item.index),
                y: item.portfolio_total
            }));
            
            const benchmarkData = data.benchmark_data.map(item => ({
                x: new Date(item.timestamp),
                y: item.value
            }));
            
            // Create ApexCharts options
            const options = {
                series: [
                    {
                        name: 'Portfolio Value',
                        data: portfolioData
                    },
                    {
                        name: 'Benchmark (Equal-Weight)',
                        data: benchmarkData,
                        type: 'line',
                        dashArray: 5
                    }
                ],
                chart: {
                    type: 'area',
                    height: 400,
                    toolbar: {
                        show: true,
                        tools: {
                            download: true,
                            selection: true,
                            zoom: true,
                            zoomin: true,
                            zoomout: true,
                            pan: true,
                            reset: true
                        }
                    }
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    curve: 'smooth',
                    width: [2, 2],
                    dashArray: [0, 5]
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shadeIntensity: 1,
                        opacityFrom: 0.7,
                        opacityTo: 0.3,
                        stops: [0, 90, 100]
                    }
                },
                colors: ['#0d6efd', '#dc3545'],
                xaxis: {
                    type: 'datetime',
                    labels: {
                        datetimeFormatter: {
                            year: 'yyyy',
                            month: "MMM 'yy",
                            day: 'dd MMM',
                            hour: 'HH:mm'
                        }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function(value) {
                            return '$' + value.toFixed(2);
                        }
                    },
                    title: {
                        text: 'Portfolio Value ($)'
                    }
                },
                tooltip: {
                    x: {
                        format: 'dd MMM yyyy HH:mm'
                    },
                    y: {
                        formatter: function(value) {
                            return '$' + value.toFixed(2);
                        }
                    }
                },
                legend: {
                    position: 'top'
                }
            };
            
            // Clear container and create chart
            $('#portfolio-chart-container').empty();
            const chart = new ApexCharts(document.querySelector('#portfolio-chart-container'), options);
            chart.render();
        }
        
        // Function to create allocation chart
        function createAllocationChart(data) {
            // Prepare data for allocation chart
            const timestamps = data.timestamps.map(ts => new Date(ts));
            const allocations = data.allocations;
            const symbols = Object.keys(allocations);
            
            // Prepare series data for stacked chart
            const series = symbols.map(symbol => ({
                name: symbol,
                data: allocations[symbol].map((value, index) => ({
                    x: timestamps[index],
                    y: value
                }))
            }));
            
            // Create ApexCharts options
            const options = {
                series: series,
                chart: {
                    type: 'area',
                    height: 300,
                    stacked: true,
                    toolbar: {
                        show: false
                    }
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    curve: 'smooth',
                    width: 1
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        opacityFrom: 0.8,
                        opacityTo: 0.6
                    }
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        datetimeFormatter: {
                            year: 'yyyy',
                            month: "MMM 'yy",
                            day: 'dd MMM',
                            hour: 'HH:mm'
                        }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function(value) {
                            return value.toFixed(0) + '%';
                        }
                    },
                    min: 0,
                    max: 100,
                    title: {
                        text: 'Allocation (%)'
                    }
                },
                tooltip: {
                    x: {
                        format: 'dd MMM yyyy HH:mm'
                    },
                    y: {
                        formatter: function(value) {
                            return value.toFixed(2) + '%';
                        }
                    }
                },
                legend: {
                    position: 'right'
                }
            };
            
            // Clear container and create chart
            $('#allocation-chart-container').empty();
            const chart = new ApexCharts(document.querySelector('#allocation-chart-container'), options);
            chart.render();
        }
        
        // Initialize portfolio graph on page load
        $(document).ready(function() {
            // Initial data loads
            updateBalance();
            updatePerformance();
            updatePriceCharts();
            updateRank();
            updateCapitalMultiplier();
            updatePortfolioGraph();
            
            // Set up auto-refresh
            const intervalMs = parseInt($('#config-data').data('interval-ms'));
            console.log(`Setting up auto-refresh every ${intervalMs}ms`);
            
            setInterval(function() {
                updateBalance();
                updatePerformance();
                updatePriceCharts();
            }, intervalMs);
        });
        
        // Function to download symbol data as CSV
        function downloadSymbolData(symbol, days) {
            console.log('Downloading data for symbol:', symbol, 'with days:', days);
            
            // Show loading indicator
            showLoadingToast('Preparing your download...');
            
            // Create a direct download link
            const downloadUrl = `/dashboard/api/download-symbol-data?symbol=${encodeURIComponent(symbol)}&days=${encodeURIComponent(days)}`;
            
            // Create a temporary link element
            const downloadLink = document.createElement('a');
            downloadLink.href = downloadUrl;
            downloadLink.setAttribute('download', `${symbol}_data_${days}days.csv`);
            downloadLink.setAttribute('target', '_blank');
            
            // Add to document, click and remove
            document.body.appendChild(downloadLink);
            downloadLink.click();
            
            // Hide loading indicator after a short delay
            setTimeout(function() {
                hideLoadingToast();
                document.body.removeChild(downloadLink);
            }, 1000);
        }
        
        // Helper function to show loading toast with custom message
        function showLoadingToast(message) {
            // Create toast if it doesn't exist
            if (!document.getElementById('loading-toast')) {
                const toastContainer = $('<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>');
                const loadingToast = $(`
                    <div id="loading-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header">
                            <strong class="me-auto">Loading</strong>
                            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                        <div class="toast-body">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span id="loading-message">Processing...</span>
                            </div>
                        </div>
                    </div>
                `);
                toastContainer.append(loadingToast);
                $('body').append(toastContainer);
            }
            
            // Update message and show toast
            $('#loading-message').text(message || 'Processing...');
            const loadingToast = new bootstrap.Toast(document.getElementById('loading-toast'));
            loadingToast.show();
        }
        
        // Helper function to hide loading toast
        function hideLoadingToast() {
            const loadingToastEl = document.getElementById('loading-toast');
            if (loadingToastEl) {
                const loadingToast = bootstrap.Toast.getInstance(loadingToastEl);
                if (loadingToast) {
                    loadingToast.hide();
                }
            }
        }
    </script>
</body>
</html>
