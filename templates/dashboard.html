<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        body {
            padding-top: 20px;
            background-color: #f5f5f5;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            font-weight: bold;
        }
        .price-up {
            color: green;
        }
        .price-down {
            color: red;
        }
        .dashboard-title {
            margin-bottom: 30px;
        }
        .signal-buy {
            background-color: rgba(0, 128, 0, 0.1);
        }
        .signal-sell {
            background-color: rgba(255, 0, 0, 0.1);
        }
        #chartContainer {
            height: 400px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center dashboard-title">Trading Bot Dashboard</h1>
        
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">Active Symbols</div>
                    <div class="card-body">
                        <div class="list-group" id="symbolList">
                            {% for symbol in active_symbols %}
                            <a href="#" class="list-group-item list-group-item-action symbol-item" data-symbol="{{ symbol }}">
                                {{ symbol }}
                                <span class="float-end" id="price-{{ symbol }}">Loading...</span>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">Portfolio Status</div>
                    <div class="card-body">
                        <div id="portfolioStatus">
                            <p>Total Value: <span id="portfolioValue">Loading...</span></p>
                            <p>Cash: <span id="portfolioCash">Loading...</span></p>
                            <p>Today's P&L: <span id="portfolioPnL">Loading...</span></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header">
                        <span id="selectedSymbolHeader">Price Chart</span>
                        <span class="float-end" id="lastUpdate"></span>
                    </div>
                    <div class="card-body">
                        <div id="chartContainer">
                            <canvas id="priceChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Signal Data</div>
                            <div class="card-body">
                                <div id="signalData">
                                    <table class="table table-sm">
                                        <tr>
                                            <td>Daily Composite:</td>
                                            <td id="dailyComposite">-</td>
                                        </tr>
                                        <tr>
                                            <td>Daily Upper Limit:</td>
                                            <td id="dailyUpperLimit">-</td>
                                        </tr>
                                        <tr>
                                            <td>Daily Lower Limit:</td>
                                            <td id="dailyLowerLimit">-</td>
                                        </tr>
                                        <tr>
                                            <td>Weekly Composite:</td>
                                            <td id="weeklyComposite">-</td>
                                        </tr>
                                        <tr>
                                            <td>Weekly Upper Limit:</td>
                                            <td id="weeklyUpperLimit">-</td>
                                        </tr>
                                        <tr>
                                            <td>Weekly Lower Limit:</td>
                                            <td id="weeklyLowerLimit">-</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Recent Signals</div>
                            <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                                <div id="recentSignals">
                                    <p>Loading signals...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">Recent Trades</div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-striped table-sm" id="tradesTable">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Symbol</th>
                                    <th>Type</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody id="tradesTableBody">
                                <tr>
                                    <td colspan="6" class="text-center">No recent trades</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global chart instance
        let priceChart = null;
        let currentSymbol = null;
        let priceHistory = {};
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Setup symbol list click handlers
            const symbolItems = document.querySelectorAll('.symbol-item');
            symbolItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const symbol = this.getAttribute('data-symbol');
                    loadSymbolData(symbol);
                    
                    // Update active state
                    symbolItems.forEach(s => s.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Load first symbol if available
            if (symbolItems.length > 0) {
                const firstSymbol = symbolItems[0].getAttribute('data-symbol');
                loadSymbolData(firstSymbol);
                symbolItems[0].classList.add('active');
            }
            
            // Start update loops
            updatePrices();
            updatePortfolioData();
            updateRecentSignals();
            updateRecentTrades();
        });
        
        // Function to load symbol data
        function loadSymbolData(symbol) {
            currentSymbol = symbol;
            document.getElementById('selectedSymbolHeader').textContent = `Price Chart: ${symbol}`;
            
            fetch(`/api/data/${symbol}`)
                .then(response => response.json())
                .then(data => {
                    updateSymbolData(symbol, data);
                    
                    // Initialize or update price history
                    if (!priceHistory[symbol]) {
                        priceHistory[symbol] = [];
                    }
                    
                    // Use historical data if available
                    if (data.price_history && Array.isArray(data.price_history)) {
                        priceHistory[symbol] = data.price_history.map(item => ({
                            timestamp: item.timestamp,
                            price: item.price,
                            signal: item.signal || null
                        }));
                        console.log(`Loaded ${priceHistory[symbol].length} price history points for ${symbol}`);
                    } else {
                        // Add current price to history if no historical data
                        const timestamp = new Date().toISOString();
                        priceHistory[symbol].push({
                            timestamp,
                            price: data.current_price
                        });
                        console.log(`No price history available for ${symbol}, using current price only`);
                        
                        // Keep only last 100 points
                        if (priceHistory[symbol].length > 100) {
                            priceHistory[symbol] = priceHistory[symbol].slice(-100);
                        }
                    }
                    
                    updatePriceChart(symbol);
                })
                .catch(error => console.error('Error fetching symbol data:', error));
        }
        
        // Function to update symbol data display
        function updateSymbolData(symbol, data) {
            // Update signal data
            document.getElementById('dailyComposite').textContent = data.daily_composite?.toFixed(4) || '-';
            document.getElementById('dailyUpperLimit').textContent = data.daily_upper_limit?.toFixed(4) || '-';
            document.getElementById('dailyLowerLimit').textContent = data.daily_lower_limit?.toFixed(4) || '-';
            document.getElementById('weeklyComposite').textContent = data.weekly_composite?.toFixed(4) || '-';
            document.getElementById('weeklyUpperLimit').textContent = data.weekly_upper_limit?.toFixed(4) || '-';
            document.getElementById('weeklyLowerLimit').textContent = data.weekly_lower_limit?.toFixed(4) || '-';
            
            // Update last update time
            const lastUpdate = new Date(data.timestamp);
            document.getElementById('lastUpdate').textContent = `Last update: ${lastUpdate.toLocaleString()}`;
        }
        
        // Function to update prices
        function updatePrices() {
            fetch('/api/prices')
                .then(response => response.json())
                .then(data => {
                    for (const [symbol, price] of Object.entries(data)) {
                        const priceElement = document.getElementById(`price-${symbol}`);
                        if (priceElement) {
                            priceElement.textContent = `$${price.toFixed(2)}`;
                            
                            // Add to price history if it's the current symbol
                            if (symbol === currentSymbol) {
                                const timestamp = new Date().toISOString();
                                if (!priceHistory[symbol]) {
                                    priceHistory[symbol] = [];
                                }
                                
                                // Only add if price changed
                                const lastPrice = priceHistory[symbol].length > 0 ? 
                                    priceHistory[symbol][priceHistory[symbol].length - 1].price : null;
                                
                                if (lastPrice !== price) {
                                    priceHistory[symbol].push({
                                        timestamp,
                                        price
                                    });
                                    
                                    // Keep only last 100 points
                                    if (priceHistory[symbol].length > 100) {
                                        priceHistory[symbol] = priceHistory[symbol].slice(-100);
                                    }
                                    
                                    // Update chart
                                    updatePriceChart(symbol);
                                }
                            }
                        }
                    }
                })
                .catch(error => console.error('Error fetching prices:', error))
                .finally(() => {
                    // Schedule next update
                    setTimeout(updatePrices, 5000);  // Every 5 seconds
                });
        }
        
        // Function to update price chart
        function updatePriceChart(symbol) {
            if (!priceHistory[symbol] || priceHistory[symbol].length === 0) {
                console.log(`No price history available for ${symbol}`);
                return;
            }
            
            console.log(`Updating price chart for ${symbol} with ${priceHistory[symbol].length} data points`);
            
            const chartData = priceHistory[symbol];
            const labels = chartData.map(d => {
                const date = new Date(d.timestamp);
                // Format date as MM/DD HH:MM
                return `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            });
            const prices = chartData.map(d => d.price);
            
            // Extract buy and sell signals
            const buySignals = [];
            const sellSignals = [];
            
            chartData.forEach((d, index) => {
                if (d.signal === 'buy') {
                    buySignals.push({
                        x: labels[index],
                        y: d.price
                    });
                } else if (d.signal === 'sell') {
                    sellSignals.push({
                        x: labels[index],
                        y: d.price
                    });
                } else {
                    // Push null to maintain array length
                    buySignals.push(null);
                    sellSignals.push(null);
                }
            });
            
            // Create annotations for signals
            const annotations = [];
            chartData.forEach((d, index) => {
                if (d.signal === 'buy') {
                    annotations.push({
                        type: 'line',
                        mode: 'vertical',
                        scaleID: 'x',
                        value: labels[index],
                        borderColor: 'rgba(0, 255, 0, 0.5)',
                        borderWidth: 2,
                        label: {
                            content: 'BUY',
                            enabled: true,
                            position: 'top',
                            backgroundColor: 'rgba(0, 255, 0, 0.7)'
                        }
                    });
                } else if (d.signal === 'sell') {
                    annotations.push({
                        type: 'line',
                        mode: 'vertical',
                        scaleID: 'x',
                        value: labels[index],
                        borderColor: 'rgba(255, 0, 0, 0.5)',
                        borderWidth: 2,
                        label: {
                            content: 'SELL',
                            enabled: true,
                            position: 'top',
                            backgroundColor: 'rgba(255, 0, 0, 0.7)'
                        }
                    });
                }
            });
            
            if (priceChart) {
                priceChart.destroy();
                priceChart = null;
            }
            
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: `${symbol} Price`,
                            data: prices,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1,
                            fill: false,
                            pointRadius: 2,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Buy Signals',
                            data: buySignals,
                            pointBackgroundColor: 'green',
                            pointBorderColor: 'green',
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            showLine: false
                        },
                        {
                            label: 'Sell Signals',
                            data: sellSignals,
                            pointBackgroundColor: 'red',
                            pointBorderColor: 'red',
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            showLine: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Price ($)'
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const datasetLabel = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    return datasetLabel + ': ' + value;
                                }
                            }
                        },
                        annotation: {
                            annotations: annotations
                        }
                    }
                }
            });
        }
        
        // Function to update portfolio data
        function updatePortfolioData() {
            fetch('/api/portfolio')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const latest = data[data.length - 1];
                        document.getElementById('portfolioValue').textContent = `$${latest.total_value.toFixed(2)}`;
                        document.getElementById('portfolioCash').textContent = `$${latest.cash.toFixed(2)}`;
                        
                        const pnl = latest.today_pnl;
                        const pnlElement = document.getElementById('portfolioPnL');
                        pnlElement.textContent = `$${Math.abs(pnl).toFixed(2)} ${pnl >= 0 ? '▲' : '▼'}`;
                        pnlElement.className = pnl >= 0 ? 'price-up' : 'price-down';
                    }
                })
                .catch(error => console.error('Error fetching portfolio data:', error))
                .finally(() => {
                    // Schedule next update
                    setTimeout(updatePortfolioData, 30000);  // Every 30 seconds
                });
        }
        
        // Function to update recent signals
        function updateRecentSignals() {
            fetch('/api/signals')
                .then(response => response.json())
                .then(data => {
                    const signalsContainer = document.getElementById('recentSignals');
                    if (data.length === 0) {
                        signalsContainer.innerHTML = '<p>No signals yet</p>';
                        return;
                    }
                    
                    let html = '';
                    const recentSignals = data.slice(-5).reverse();  // Show 5 most recent signals
                    
                    recentSignals.forEach(signal => {
                        const signalClass = signal.signal === 1 ? 'signal-buy' : 'signal-sell';
                        const signalType = signal.signal === 1 ? 'BUY' : 'SELL';
                        const time = new Date(signal.timestamp).toLocaleString();
                        
                        html += `
                            <div class="alert ${signalClass} mb-2 py-2">
                                <strong>${signal.symbol} - ${signalType}</strong> at $${signal.price.toFixed(2)}<br>
                                <small>${time}</small>
                            </div>
                        `;
                    });
                    
                    signalsContainer.innerHTML = html;
                })
                .catch(error => console.error('Error fetching signal data:', error))
                .finally(() => {
                    // Schedule next update
                    setTimeout(updateRecentSignals, 10000);  // Every 10 seconds
                });
        }
        
        // Function to update recent trades
        function updateRecentTrades() {
            fetch('/api/signals')
                .then(response => response.json())
                .then(data => {
                    const tradesBody = document.getElementById('tradesTableBody');
                    if (data.length === 0) {
                        tradesBody.innerHTML = '<tr><td colspan="6" class="text-center">No recent trades</td></tr>';
                        return;
                    }
                    
                    let html = '';
                    const tradingSignals = data.filter(s => s.executed === true);
                    const recentTrades = tradingSignals.slice(-10).reverse();  // Show 10 most recent trades
                    
                    recentTrades.forEach(trade => {
                        const tradeType = trade.signal === 1 ? 'BUY' : 'SELL';
                        const typeClass = trade.signal === 1 ? 'text-success' : 'text-danger';
                        const time = new Date(trade.timestamp).toLocaleString();
                        
                        html += `
                            <tr>
                                <td>${time}</td>
                                <td>${trade.symbol}</td>
                                <td class="${typeClass}">${tradeType}</td>
                                <td>$${trade.price.toFixed(2)}</td>
                                <td>${trade.quantity?.toFixed(8) || '-'}</td>
                                <td>$${(trade.price * (trade.quantity || 0)).toFixed(2)}</td>
                            </tr>
                        `;
                    });
                    
                    if (html) {
                        tradesBody.innerHTML = html;
                    } else {
                        tradesBody.innerHTML = '<tr><td colspan="6" class="text-center">No executed trades yet</td></tr>';
                    }
                })
                .catch(error => console.error('Error fetching trade data:', error))
                .finally(() => {
                    // Schedule next update
                    setTimeout(updateRecentTrades, 10000);  // Every 10 seconds
                });
        }
    </script>
</body>
</html>