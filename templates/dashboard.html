<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        body {
            padding-top: 20px;
            background-color: #f5f5f5;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            font-weight: bold;
        }
        .price-up {
            color: green;
        }
        .price-down {
            color: red;
        }
        .dashboard-title {
            margin-bottom: 30px;
        }
        .signal-buy {
            background-color: rgba(0, 128, 0, 0.1);
        }
        .signal-sell {
            background-color: rgba(255, 0, 0, 0.1);
        }
        #chartContainer {
            height: 400px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center dashboard-title">Trading Bot Dashboard</h1>

        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">Active Symbols</div>
                    <div class="card-body">
                        <div class="list-group" id="symbolList">
                            {% for symbol in active_symbols %}
                            <a href="#" class="list-group-item list-group-item-action symbol-item" data-symbol="{{ symbol }}">
                                {{ symbol }}
                                <span class="float-end" id="price-{{ symbol }}">Loading...</span>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Portfolio Status</div>
                    <div class="card-body">
                        <div id="portfolioStatus">
                            <p>Total Value: <span id="portfolioValue">Loading...</span></p>
                            <p>Cash: <span id="portfolioCash">Loading...</span></p>
                            <p>Today's P&L: <span id="portfolioPnL">Loading...</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div class="card">
                    <div class="card-header">
                        <span id="selectedSymbolHeader">Price Chart</span>
                        <span class="float-end" id="lastUpdate"></span>
                    </div>
                    <div class="card-body">
                        <div id="chartContainer">
                            <canvas id="priceChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Signal Data</div>
                            <div class="card-body">
                                <div id="signalData">
                                    <table class="table table-sm">
                                        <tr>
                                            <td>Daily Composite:</td>
                                            <td id="dailyComposite">-</td>
                                        </tr>
                                        <tr>
                                            <td>Daily Upper Limit:</td>
                                            <td id="dailyUpperLimit">-</td>
                                        </tr>
                                        <tr>
                                            <td>Daily Lower Limit:</td>
                                            <td id="dailyLowerLimit">-</td>
                                        </tr>
                                        <tr>
                                            <td>Weekly Composite:</td>
                                            <td id="weeklyComposite">-</td>
                                        </tr>
                                        <tr>
                                            <td>Weekly Upper Limit:</td>
                                            <td id="weeklyUpperLimit">-</td>
                                        </tr>
                                        <tr>
                                            <td>Weekly Lower Limit:</td>
                                            <td id="weeklyLowerLimit">-</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Recent Signals</div>
                            <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                                <div id="recentSignals">
                                    <p>Loading signals...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">Recent Trades</div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-striped table-sm" id="tradesTable">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Symbol</th>
                                    <th>Type</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody id="tradesTableBody">
                                <tr>
                                    <td colspan="6" class="text-center">No recent trades</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Wait for page to load
        $(document).ready(function() {
            // Global variables for chart
            let priceChart = null;
            let priceHistory = {};
            let activeSymbol = null;

            // Initialize dashboard
            $.getJSON('/api/symbols', function(data) {
                const symbols = data.symbols;
                if (symbols && symbols.length > 0) {
                    // Load first symbol by default
                    activeSymbol = symbols[0];
                    loadSymbolData(activeSymbol);

                    // Set up refresh interval
                    setInterval(function() {
                        if (activeSymbol) {
                            loadSymbolData(activeSymbol);
                        }
                    }, 5000);
                }
            });

            // Click handler for symbols
            $('#symbolList').on('click', '.symbol-item', function(e) {
                e.preventDefault();
                const symbol = $(this).data('symbol');
                activeSymbol = symbol;
                loadSymbolData(symbol);
            });

            // Start data updates
            updatePrices();
            updatePortfolio();
            updateSignals();
            updateRecentTrades();

            // Function to load symbol data
            function loadSymbolData(symbol) {
                $.getJSON(`/api/data/${symbol}`).done(function(data) {
                    // Update chart title
                    $('#selectedSymbolHeader').text(`Price Chart: ${symbol}`);

                    // Update price history
                    if (data.price_history && Array.isArray(data.price_history)) {
                        priceHistory[symbol] = data.price_history;
                        updatePriceChart(symbol);
                    }

                    // Update signal data
                    updateSignalData(data);
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.error(`Error loading data for ${symbol}:`, textStatus, errorThrown);
                });
            }

            // Function to update signal data display
            function updateSignalData(data) {
                $('#dailyComposite').text(data.daily_composite?.toFixed(4) || '-');
                $('#dailyUpperLimit').text(data.daily_upper_limit?.toFixed(4) || '-');
                $('#dailyLowerLimit').text(data.daily_lower_limit?.toFixed(4) || '-');
                $('#weeklyComposite').text(data.weekly_composite?.toFixed(4) || '-');
                $('#weeklyUpperLimit').text(data.weekly_upper_limit?.toFixed(4) || '-');
                $('#weeklyLowerLimit').text(data.weekly_lower_limit?.toFixed(4) || '-');
            }

            // Function to update prices
            function updatePrices() {
                $.getJSON('/api/prices').done(function(data) {
                    $.each(data, function(symbol, price) {
                        $(`#price-${symbol}`).text(`$${parseFloat(price).toFixed(2)}`);
                    });
                }).fail(function(error) {
                    console.error('Error fetching prices:', error);
                });
                setTimeout(updatePrices, 5000);
            }

            // Function to update portfolio
            function updatePortfolio() {
                $.getJSON('/api/portfolio').done(function(data) {
                    if (data.length > 0) {
                        const latest = data[data.length - 1];
                        $('#portfolioValue').text(`$${latest.total_value.toFixed(2)}`);
                        $('#portfolioCash').text(`$${latest.cash.toFixed(2)}`);

                        const pnl = latest.today_pnl;
                        const pnlElement = $('#portfolioPnL');
                        pnlElement.text(`$${Math.abs(pnl).toFixed(2)} ${pnl >= 0 ? '▲' : '▼'}`);
                        pnlElement.removeClass('price-up price-down').addClass(pnl >= 0 ? 'price-up' : 'price-down');
                    }
                });
                setTimeout(updatePortfolio, 30000);
            }

            // Function to update signals
            function updateSignals() {
                $.getJSON('/api/signals').done(function(data) {
                    const signalsContainer = $('#recentSignals');
                    if (!data || data.length === 0) {
                        signalsContainer.html('<p>No signals yet</p>');
                        return;
                    }

                    let html = '';
                    const recentSignals = data.slice(-5).reverse();

                    recentSignals.forEach(signal => {
                        const signalClass = signal.signal === 1 ? 'signal-buy' : 'signal-sell';
                        const signalType = signal.signal === 1 ? 'BUY' : 'SELL';
                        const time = new Date(signal.timestamp).toLocaleString();

                        html += `
                            <div class="alert ${signalClass} mb-2 py-2">
                                <strong>${signal.symbol} - ${signalType}</strong> at $${signal.price.toFixed(2)}<br>
                                <small>${time}</small>
                            </div>
                        `;
                    });

                    signalsContainer.html(html);
                });
                setTimeout(updateSignals, 10000);
            }

            // Function to update recent trades
            function updateRecentTrades() {
                $.getJSON('/api/signals').done(function(data) {
                    const tradesBody = $('#tradesTableBody');
                    const tradingSignals = data.filter(s => s.executed === true);

                    if (!tradingSignals || tradingSignals.length === 0) {
                        tradesBody.html('<tr><td colspan="6" class="text-center">No recent trades</td></tr>');
                        return;
                    }

                    let html = '';
                    const recentTrades = tradingSignals.slice(-10).reverse();

                    recentTrades.forEach(trade => {
                        const tradeType = trade.signal === 1 ? 'BUY' : 'SELL';
                        const typeClass = trade.signal === 1 ? 'text-success' : 'text-danger';
                        const time = new Date(trade.timestamp).toLocaleString();

                        html += `
                            <tr>
                                <td>${time}</td>
                                <td>${trade.symbol}</td>
                                <td class="${typeClass}">${tradeType}</td>
                                <td>$${trade.price.toFixed(2)}</td>
                                <td>${trade.quantity?.toFixed(8) || '-'}</td>
                                <td>$${(trade.price * (trade.quantity || 0)).toFixed(2)}</td>
                            </tr>
                        `;
                    });

                    tradesBody.html(html);
                });
                setTimeout(updateRecentTrades, 10000);
            }

            // Function to update price chart
            function updatePriceChart(symbol) {
                if (!priceHistory[symbol] || !priceHistory[symbol].length) {
                    console.log(`No price history available for ${symbol}`);
                    return;
                }

                const chartData = priceHistory[symbol];

                // Prepare data for chart
                const labels = chartData.map(d => {
                    const date = new Date(d.timestamp);
                    return `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                });

                const prices = chartData.map(d => d.price);
                const buySignals = [];
                const sellSignals = [];

                chartData.forEach((d, index) => {
                    if (d.signal === 'buy') {
                        buySignals.push({x: index, y: d.price});
                    } else if (d.signal === 'sell') {
                        sellSignals.push({x: index, y: d.price});
                    }
                });

                if (priceChart) {
                    priceChart.destroy();
                }

                const ctx = document.getElementById('priceChart').getContext('2d');
                priceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${symbol} Price`,
                            data: prices,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Price ($)'
                                }
                            }
                        }
                    }
                });

                // Add signals if they exist
                if (buySignals.length > 0) {
                    priceChart.data.datasets.push({
                        label: 'Buy Signals',
                        data: buySignals.map(p => ({x: labels[p.x], y: p.y})),
                        backgroundColor: 'green',
                        pointRadius: 6,
                        pointStyle: 'triangle',
                        showLine: false
                    });
                }

                if (sellSignals.length > 0) {
                    priceChart.data.datasets.push({
                        label: 'Sell Signals',
                        data: sellSignals.map(p => ({x: labels[p.x], y: p.y})),
                        backgroundColor: 'red',
                        pointRadius: 6,
                        pointStyle: 'triangle',
                        showLine: false
                    });
                }

                priceChart.update();
            }
        });
    </script>
</body>
</html>