<!DOCTYPE html>
<html>
<head>
    <title>Alpaca Trading Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- Use ApexCharts for candlestick charts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        .card { margin-bottom: 20px; }
        .indicator-value { font-weight: bold; }
        .positive { color: green; }
        .negative { color: red; }
        .neutral { color: gray; }
        .tab-content { padding: 20px 0; }
        .nav-tabs { margin-bottom: 20px; }
        .signal-strong { font-weight: bold; }
        .signal-buy { color: green; }
        .signal-sell { color: red; }
        .signal-neutral { color: gray; }
        .position-summary { font-size: 0.9rem; }
        .refresh-btn { cursor: pointer; }
        .symbol-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            margin-right: 0.5rem;
            font-weight: bold;
            background-color: #f8f9fa;
        }
        .market-open { color: green; }
        .market-closed { color: red; }
        #performance-chart {
            height: 300px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Alpaca Trading Dashboard</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if not active_tab or active_tab == 'overview' %}active{% endif %}" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">Overview</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" href="/dashboard/positions">Positions</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" href="/dashboard/orders">Orders</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" href="/dashboard/backtest">Backtest</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="tab-content" id="myTabContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade {% if not active_tab or active_tab == 'overview' %}show active{% endif %}" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                <div class="row">
                    <!-- Account Balance -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Account Balance <i class="bi bi-arrow-clockwise refresh-btn" onclick="updateBalance()"></i></h5>
                            </div>
                            <div class="card-body" id="balance-info">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Today's Performance <i class="bi bi-arrow-clockwise refresh-btn" onclick="updatePerformance()"></i></h5>
                            </div>
                            <div class="card-body" id="performance-info">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Symbol Price Charts -->
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Symbol Price Charts <i class="bi bi-arrow-clockwise refresh-btn" onclick="updatePriceCharts()"></i></h5>
                        <div>
                            <select class="form-select" id="price-chart-days">
                                <option value="3">3 Days</option>
                                <option value="7" selected>7 Days</option>
                                <option value="14">14 Days</option>
                                <option value="30">30 Days</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row" id="price-charts-container">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Performance Ranking -->
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Performance Ranking <i class="bi bi-arrow-clockwise refresh-btn" onclick="updateRank()"></i></h5>
                    </div>
                    <div class="card-body" id="rank-info">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Populate symbols dropdown
        const availableSymbols = JSON.parse('{{ symbols|tojson|safe }}');
        
        function populateSymbolDropdowns() {
            const symbolSelect = document.getElementById('symbol-select');
            
            // Clear existing options - add null checks
            if (symbolSelect) symbolSelect.innerHTML = '';
            
            // Add symbols to dropdowns
            availableSymbols.forEach(symbol => {
                // Strategy visualization dropdown
                if (symbolSelect) {
                    const option1 = document.createElement('option');
                    option1.value = symbol;
                    option1.text = symbol;
                    symbolSelect.appendChild(option1);
                }
            });
        }

        // Format number as currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
        }
        
        // Format number as percentage
        function formatPercentage(value) {
            return new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value/100);
        }
        
        // Format number with 2 decimal places
        function formatNumber(value) {
            return new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
        }
        
        // Get CSS class for positive/negative values
        function getValueClass(value) {
            return value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
        }
        
        // Get CSS class for signal
        function getSignalClass(signal) {
            if (signal.includes('STRONG BUY') || signal.includes('WEAK BUY')) {
                return 'signal-buy' + (signal.includes('STRONG') ? ' signal-strong' : '');
            } else if (signal.includes('STRONG SELL') || signal.includes('WEAK SELL')) {
                return 'signal-sell' + (signal.includes('STRONG') ? ' signal-strong' : '');
            } else {
                return 'signal-neutral';
            }
        }

        function sanitizeSymbolForId(symbol) {
            // Replace any non-alphanumeric characters with underscores
            return symbol.replace(/[^a-zA-Z0-9]/g, '_');
        }
        
        // Update functions
        function updateBalance() {
            $.get('/dashboard/api/balance', function(data) {
                if (data.error) {
                    $('#balance-info').html(`<div class="alert alert-danger">${data.error}</div>`);
                    return;
                }
                
                const todayPL = data.today_pl || 0;
                const todayPLClass = getValueClass(todayPL);
                
                const balanceHtml = `
                    <div class="row">
                        <div class="col-md-3">
                            <p>Cash: ${formatCurrency(data.cash)}</p>
                        </div>
                        <div class="col-md-3">
                            <p>Portfolio Value: ${formatCurrency(data.portfolio_value)}</p>
                        </div>
                        <div class="col-md-3">
                            <p>Buying Power: ${formatCurrency(data.buying_power)}</p>
                        </div>
                        <div class="col-md-3">
                            <p>Today's P&L: <span class="${todayPLClass}">${formatCurrency(todayPL)}</span></p>
                        </div>
                    </div>
                `;
                $('#balance-info').html(balanceHtml);
            });
        }
        
        function updatePerformance() {
            $.get('/dashboard/api/performance', function(data) {
                if (data.error) {
                    $('#performance-info').html(`<div class="alert alert-danger">${data.error}</div>`);
                    return;
                }
                
                const todayPLClass = getValueClass(data.today_pl);
                
                const performanceHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <p>Today's P&L: <span class="${todayPLClass}">${formatCurrency(data.today_pl)} (${formatPercentage(data.today_pl_pct)})</span></p>
                        </div>
                        <div class="col-md-6">
                            <p>Starting Equity: ${formatCurrency(data.starting_equity)}</p>
                            <p>Current Equity: ${formatCurrency(data.current_equity)}</p>
                        </div>
                    </div>
                `;
                $('#performance-info').html(performanceHtml);
            });
        }
        
        function updateMarkets() {
            $.get('/dashboard/api/markets', function(data) {
                if (Object.keys(data).length === 0) {
                    $('#markets-info').html(`<div class="alert alert-warning">No market data available</div>`);
                    return;
                }
                
                let marketsHtml = '<div class="row">';
                
                for (const [symbol, info] of Object.entries(data)) {
                    if (info.error) continue;
                    
                    const statusClass = info.is_open ? 'market-open' : 'market-closed';
                    const statusText = info.is_open ? 'Open' : 'Closed';
                    
                    marketsHtml += `
                        <div class="col-md-3 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6>${symbol} (${info.name})</h6>
                                    <p>Exchange: ${info.exchange}</p>
                                    <p>Status: <span class="${statusClass}">${statusText}</span></p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                marketsHtml += '</div>';
                $('#markets-info').html(marketsHtml);
            });
        }

        function updateStatus() {
            $.get('/dashboard/api/status', function(data) {
                if (Object.keys(data).length === 0) {
                    $('#status-info').html(`<div class="alert alert-warning">No status data available</div>`);
                    return;
                }
                
                let statusHtml = '<div class="row">';
                
                for (const [symbol, info] of Object.entries(data)) {
                    if (info.error) continue;
                    
                    const dailyCompositeClass = getValueClass(info.daily_composite);
                    const weeklyCompositeClass = getValueClass(info.weekly_composite);
                    const price5mClass = getValueClass(info.price_change_5m);
                    const price1hClass = getValueClass(info.price_change_1h);
                    
                    statusHtml += `
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6>${symbol} (${info.name})</h6>
                                </div>
                                <div class="card-body">
                                    <p>Position: <strong>${info.position}</strong></p>
                                    <p>Current Price: ${formatCurrency(info.current_price)}</p>
                                    <p>P&L: ${info.pos_pnl}</p>
                                    <p>Daily Composite: <span class="${dailyCompositeClass}">${formatNumber(info.daily_composite)}</span></p>
                                    <p>Weekly Composite: <span class="${weeklyCompositeClass}">${formatNumber(info.weekly_composite)}</span></p>
                                    <p>5m Change: <span class="${price5mClass}">${formatPercentage(info.price_change_5m)}</span></p>
                                    <p>1h Change: <span class="${price1hClass}">${formatPercentage(info.price_change_1h)}</span></p>
                                    <p>Parameters: ${info.params}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                statusHtml += '</div>';
                $('#status-info').html(statusHtml);
            });
        }
        
        function updateRank() {
            const days = parseInt($('#price-chart-days').val());
            console.log('updateRank called with days:', days);
            $.get(`/dashboard/api/rank?days=${days}`, function(data) {
                if (data.error) {
                    $('#rank-info').html(`<div class="alert alert-danger">${data.error}</div>`);
                    return;
                }
                
                // Create performance chart
                createPerformanceChart(data);
            });
        }
        
        function createPerformanceChart(data) {
            // Clear previous content
            $('#rank-info').empty();
            
            console.log('Performance data:', data);
            
            // Check if we have the performance data in the expected format
            if (!data || !data.performance || !Array.isArray(data.performance) || data.performance.length === 0) {
                console.warn('Performance data is not in expected format:', data);
                $('#rank-info').html('<div class="alert alert-warning">No performance data available</div>');
                return;
            }
            
            // Sort the performance data by return percentage (descending)
            const sortedPerformance = [...data.performance].sort((a, b) => b.return_pct - a.return_pct);
            
            // Create container for the bar chart and table
            const container = $('<div class="row"></div>');
            const chartCol = $('<div class="col-md-6"></div>');
            const tableCol = $('<div class="col-md-6"></div>');
            
            // Create canvas for the bar chart
            const canvas = $('<canvas></canvas>').attr('id', 'performance-bar-chart');
            chartCol.append(canvas);
            
            // Create table for the performance data
            const table = $(`
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Symbol</th>
                                <th>Return (%)</th>
                            </tr>
                        </thead>
                        <tbody id="performance-table-body">
                        </tbody>
                    </table>
                </div>
            `);
            tableCol.append(table);
            
            // Add both columns to the container
            container.append(chartCol);
            container.append(tableCol);
            
            // Add the container to the rank-info div
            $('#rank-info').append(container);
            
            // Populate the table
            const tableBody = $('#performance-table-body');
            sortedPerformance.forEach((item, index) => {
                const returnClass = item.return_pct >= 0 ? 'text-success' : 'text-danger';
                tableBody.append(`
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.symbol}</td>
                        <td class="${returnClass}">${item.return_pct.toFixed(2)}%</td>
                    </tr>
                `);
            });
            
            // Create the bar chart
            const ctx = document.getElementById('performance-bar-chart').getContext('2d');
            const labels = sortedPerformance.map(item => item.symbol);
            const returns = sortedPerformance.map(item => item.return_pct);
            const backgroundColors = returns.map(value => 
                value >= 0 ? 'rgba(75, 192, 75, 0.7)' : 'rgba(255, 99, 132, 0.7)'
            );
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Return (%)',
                        data: returns,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',  // Horizontal bar chart
                    plugins: {
                        title: {
                            display: true,
                            text: `${data.days}-Day Performance Ranking`
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Return (%)'
                            }
                        }
                    }
                }
            });
        }
        
        function updatePriceCharts() {
            const days = parseInt($('#price-chart-days').val());
            console.log('updatePriceCharts called with days:', days);
            const container = $('#price-charts-container');
            container.html('<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>');
            
            // Fetch symbols first
            $.ajax({
                url: '/dashboard/api/symbols',
                method: 'GET',
                success: function(data) {
                    container.empty();
                    
                    // Create a row with columns for each symbol
                    data.forEach(function(symbolData) {
                        // Use the original symbol key for API calls
                        const symbol = symbolData.symbol;
                        const safeSymbolId = sanitizeSymbolForId(symbol);
                        
                        // Create a column for each symbol
                        const col = $('<div class="col-md-6 col-lg-6 mb-4"></div>');
                        const card = $('<div class="card h-100"></div>');
                        const cardHeader = $('<div class="card-header"></div>').text(symbolData.name);
                        const cardBody = $('<div class="card-body p-2"></div>');
                        const chartContainer = $('<div class="chart-container" style="position: relative; height: 600px; width: 100%;"></div>');
                        const canvas = $('<canvas></canvas>').attr('id', 'price-chart-' + safeSymbolId);
                        
                        chartContainer.append(canvas);
                        cardBody.append(chartContainer);
                        card.append(cardHeader);
                        card.append(cardBody);
                        col.append(card);
                        container.append(col);
                        
                        // Fetch price data for this symbol with the current days value
                        fetchPriceData(symbol, safeSymbolId, days);
                    });
                },
                error: function(error) {
                    container.html('<div class="alert alert-danger">Error loading symbols: ' + (error.responseJSON?.error || 'Unknown error') + '</div>');
                }
            });
        }
        
        function fetchPriceData(symbol, safeSymbolId, days) {
            console.log('fetchPriceData called for symbol:', symbol, 'with days:', days);
            $.ajax({
                url: '/dashboard/api/price-data',
                method: 'GET',
                data: {
                    symbol: symbol,
                    days: days
                },
                success: function(data) {
                    console.log('Price data received for', symbol, 'with days:', data.days);
                    createPriceChart(symbol, safeSymbolId, data);
                },
                error: function(error) {
                    $('#price-chart-' + safeSymbolId).parent().html('<div class="alert alert-danger">Error loading price data: ' + (error.responseJSON?.error || 'Unknown error') + '</div>');
                }
            });
        }
        
        function createPriceChart(symbol, safeSymbolId, data) {
            // Create container for all charts related to this symbol
            const chartContainer = $('#price-chart-' + safeSymbolId).parent();
            chartContainer.empty();
            
            // Increase the height of the chart container to fit all three charts
            chartContainer.css('height', '600px');
            
            // Create div containers for each chart to ensure proper spacing
            const priceChartDiv = $('<div style="height: 250px; margin-bottom: 10px;"></div>').attr('id', 'price-chart-container-' + safeSymbolId);
            const dailyChartDiv = $('<div style="height: 150px; margin-bottom: 10px;"></div>');
            const weeklyChartDiv = $('<div style="height: 150px;"></div>');
            
            // Create canvas elements for indicator charts
            const dailyCanvas = $('<canvas></canvas>').attr('id', 'daily-indicator-chart-' + safeSymbolId);
            const weeklyCanvas = $('<canvas></canvas>').attr('id', 'weekly-indicator-chart-' + safeSymbolId);
            
            // Add canvases to their respective divs
            dailyChartDiv.append(dailyCanvas);
            weeklyChartDiv.append(weeklyCanvas);
            
            // Add all divs to the container
            chartContainer.append(priceChartDiv);
            chartContainer.append(dailyChartDiv);
            chartContainer.append(weeklyChartDiv);
            
            // Add titles for each chart
            const dailyTitle = $('<h6 class="text-center mt-2 mb-1">Daily Composite Indicator</h6>');
            const weeklyTitle = $('<h6 class="text-center mt-2 mb-1">Weekly Composite Indicator</h6>');
            
            // Insert titles before the charts
            dailyChartDiv.before(dailyTitle);
            weeklyChartDiv.before(weeklyTitle);
            
            // 1. Create Price Chart with Candlesticks using ApexCharts
            const ohlcData = data.ohlc.map(item => {
                return {
                    x: new Date(item.x).getTime(),
                    y: [item.o, item.h, item.l, item.c]
                };
            });
            
            const options = {
                series: [{
                    name: data.name,
                    data: ohlcData
                }],
                chart: {
                    type: 'candlestick',
                    height: 250,
                    toolbar: {
                        show: false
                    }
                },
                title: {
                    text: data.name + ' Price',
                    align: 'left'
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        datetimeUTC: false,
                        format: 'MMM dd'
                    }
                },
                yaxis: {
                    tooltip: {
                        enabled: true
                    },
                    title: {
                        text: 'Price (USD)'
                    },
                    labels: {
                        formatter: function(value) {
                            // Format to a maximum of 6 decimal places, removing trailing zeros
                            return parseFloat(value.toFixed(6)).toString();
                        }
                    }
                },
                plotOptions: {
                    candlestick: {
                        colors: {
                            upward: '#3C90EB',
                            downward: '#DF7D46'
                        }
                    }
                }
            };
            
            const priceChart = new ApexCharts(document.getElementById('price-chart-container-' + safeSymbolId), options);
            priceChart.render();
            
            // 2. Create Daily Composite Indicator Chart
            const dailyCtx = dailyCanvas.get(0).getContext('2d');
            new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Daily Composite',
                            data: data.daily_composite,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Upper Limit',
                            data: data.daily_up_lim,
                            borderColor: 'rgba(75, 192, 75, 0.8)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Lower Limit',
                            data: data.daily_down_lim,
                            borderColor: 'rgba(255, 99, 132, 0.8)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Upper 2STD',
                            data: data.daily_up_lim_2std,
                            borderColor: 'rgba(75, 192, 75, 0.6)',
                            borderWidth: 1,
                            borderDash: [2, 2],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Lower 2STD',
                            data: data.daily_down_lim_2std,
                            borderColor: 'rgba(255, 99, 132, 0.6)',
                            borderWidth: 1,
                            borderDash: [2, 2],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 10,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: false // Hide x-axis labels
                        },
                        y: {
                            display: true,
                            beginAtZero: false,
                            grace: '10%', // Add some space at the top and bottom
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
            
            // 3. Create Weekly Composite Indicator Chart
            const weeklyCtx = weeklyCanvas.get(0).getContext('2d');
            new Chart(weeklyCtx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Weekly Composite',
                            data: data.weekly_composite,
                            borderColor: 'rgba(153, 102, 255, 1)',
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Upper Limit',
                            data: data.weekly_up_lim,
                            borderColor: 'rgba(75, 192, 75, 0.8)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Lower Limit',
                            data: data.weekly_down_lim,
                            borderColor: 'rgba(255, 99, 132, 0.8)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Upper 2STD',
                            data: data.weekly_up_lim_2std,
                            borderColor: 'rgba(75, 192, 75, 0.6)',
                            borderWidth: 1,
                            borderDash: [2, 2],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Lower 2STD',
                            data: data.weekly_down_lim_2std,
                            borderColor: 'rgba(255, 99, 132, 0.6)',
                            borderWidth: 1,
                            borderDash: [2, 2],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 10,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: false // Hide x-axis labels
                        },
                        y: {
                            display: true,
                            beginAtZero: false,
                            grace: '10%', // Add some space at the top and bottom
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        }

        // Set up price chart days change handler
        $('#price-chart-days').change(function() {
            console.log('price-chart-days changed to:', $(this).val());
            updatePriceCharts();
        });

        // Initialize dashboard
        $(document).ready(function() {
            populateSymbolDropdowns();
            updateBalance();
            updatePerformance();
            updatePriceCharts();
            updateRank();
        });
    </script>
</body>
</html>
